<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Sapali Group — v9.2 (Windows polish: compact search, theme/lang, light AI bubble)</title>
<style>html{overflow-x:hidden}

  :root{
    --bg:#0e141b; --panel:#121a23; --panel-2:#0b1117; --text:#ebeff3; --muted:#a6b3c2;
    --primary:#1dd1a1; --accent:#3cfcd4; --blue:#3aa0ff; --border:1px solid rgba(255,255,255,.08);
    --shadow:0 10px 28px rgba(0,0,0,.55); --radius:16px; --link:#33e2bf;
    --img1:#222; --img2:#111;
    --bubble-ai-bg:#18222e; --bubble-ai-border:rgba(255,255,255,.06); --bubble-ai-text:#dfe7ef;
  }
  .light{
    --bg:#f5f7fb; --panel:#ffffff; --panel-2:#f1f4f9; --text:#0c1622; --muted:#4c5b6b;
    --primary:#006edc; --accent:#7bc4ff; --blue:#1d71ff; --border:1px solid rgba(16,24,40,.08);
    --shadow:0 12px 28px rgba(16,24,40,.12); --link:#0049b8;
    --img1:#f4f6fb; --img2:#e7ebf3;
    --bubble-ai-bg:#ffffff; --bubble-ai-border:rgba(16,24,40,.08); --bubble-ai-text:#0c1622;
  }
  *{box-sizing:border-box}
  body{margin:0;overflow-x:hidden;max-width:100vw;background:radial-gradient(1000px 700px at 75% -10%,rgba(29,209,161,.08),transparent 60%),linear-gradient(180deg,var(--bg),var(--panel-2));color:var(--text);font:15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;min-height:100vh;display:flex;flex-direction:column;}
  a{color:var(--link); text-decoration:none; font-weight:600}
  a:hover{text-decoration:underline}

  /* Header */
  #leftNav{display:none}

  header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:var(--border);box-shadow:var(--shadow);}
  .topline{display:flex;align-items:center;gap:10px;padding:10px 12px;min-height:56px}
  .logo{width:30px;height:30px;border-radius:8px;background:conic-gradient(from 210deg,var(--primary),var(--accent),var(--primary));box-shadow:0 6px 18px rgba(29,209,161,.35);}
  .brand{font-weight:800;letter-spacing:.2px; cursor:pointer;}
  .toolbar{margin-left:auto;display:flex;gap:8px; align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--text);border:var(--border)}
  .seg{display:flex;border-radius:12px;border:var(--border);overflow:hidden}
  .seg button{background:transparent;border:0;padding:6px 10px;color:var(--muted);font-weight:700;cursor:pointer}
  .seg button.active{background:linear-gradient(180deg,var(--panel-2),transparent); color:var(--text)}

  /* Searchbar – mobile version (dưới header) */
  #searchMobile{display:flex;gap:8px;align-items:center;background:var(--panel-2);padding:6px 8px;border-radius:12px;border:var(--border);margin:6px 12px 12px;}
  #searchMobile input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:15px}

  /* Searchbar – desktop center top (compact) */
  #searchDesktop{display:none;}

  /* Content */
  main{flex:1;padding:12px;max-width:1200px;margin:0 auto;width:100%;max-width:100vw;overflow-x:hidden}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);margin:10px 0}
  .imgbox{width:160px;height:110px;border-radius:12px;border:var(--border);background:linear-gradient(180deg,var(--img1),var(--img2))}
  .scroll-x{overflow-x:auto}
  table{width:100%;border-collapse:collapse;min-width:640px}
  th,td{padding:10px;border-bottom:var(--border);text-align:left;vertical-align:top}
  th{color:var(--muted);font-size:12px;letter-spacing:.3px;text-transform:uppercase}
  .pill{padding:6px 10px;border-radius:999px;border:var(--border);background:rgba(255,255,255,.06);color:var(--muted);font-size:12px}

  /* Bottom Tabs (mobile) */
  .bottom-nav{position:sticky;bottom:0;z-index:30;background:var(--panel);border-top:var(--border);display:grid;grid-template-columns:repeat(4,1fr);gap:4px;padding:6px 6px 10px}
  .btab{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px 6px;border-radius:12px;color:var(--muted);border:1px solid transparent;cursor:pointer;user-select:none}
  .btab.active{border:1px solid var(--blue);box-shadow:0 0 0 2px rgba(61,140,255,.12);color:var(--text)} /* Light mode: chữ vẫn tối */
  .btab svg{width:22px;height:22px;filter:drop-shadow(0 3px 8px rgba(0,0,0,.35))}
  section.view{display:none}
  section.view.active{display:block}

  /* Landscape tweaks (mobile ngang) */
  @media (orientation: landscape) and (max-width: 1023px){
    .btab div{font-size:12px}
    .btab svg{width:20px;height:20px}
    #searchMobile{max-width:480px;margin:6px auto 12px}
    table{min-width:760px}
  }

  /* Desktop (Windows) — tab dọc + search center top */
  @media (min-width: 1024px){
    body{flex-direction:row}
    header{position:fixed; top:0; left:0; bottom:0; width:260px; border-right:var(--border); border-bottom:0;}
    .topline{padding:16px}
    #searchMobile{display:none}
    main{margin-left:260px; max-width:unset; padding:76px 28px 16px} /* chừa chỗ cho searchDesktop */
    .bottom-nav{display:none}

    /* search top center (gọn, không lệch) */
    #searchDesktop{display:flex;position:fixed;left:calc(260px + 50%);transform:translateX(-50%);top:12px;width:min(720px,65vw);
      z-index:25;gap:6px;align-items:center;background:var(--panel);padding:6px 8px;border-radius:12px;border:var(--border);box-shadow:var(--shadow)}
    #searchDesktop input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px}
    #searchDesktop .btn{padding:6px 10px;border-radius:10px}
    /* left nav vertical */
    #leftNav{display:flex; flex-direction:column; gap:8px; padding:10px 12px 12px;}
    .vtab{display:flex; align-items:center; gap:10px; padding:12px; border-radius:12px; color:var(--muted); cursor:pointer; border:1px solid transparent;}
    .vtab svg{width:20px;height:20px}
    .vtab.active{border:1px solid var(--blue); box-shadow:inset 0 0 0 1px rgba(61,140,255,.07); color:var(--text); background:linear-gradient(180deg,var(--panel),var(--panel-2));}
  }

  /* Modal (camera/gallery) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{width:min(420px,92vw)}

  /* AI PANEL */
  #aiPanel{display:none;flex-direction:column;z-index:60}
  /* Mobile: full-tab */
  @media (max-width: 1023px){
    #aiPanel{position:fixed;inset:0;background:linear-gradient(180deg,var(--panel),var(--panel-2));}
  }
  /* Desktop: panel trong vùng nội dung, chừa sidebar trái */
  @media (min-width: 1024px){
    #aiPanel{position:fixed;left:280px;right:40px;top:84px;bottom:40px;background:linear-gradient(180deg,var(--panel),var(--panel-2));border:var(--border);border-radius:16px;box-shadow:var(--shadow)}
  }
  #aiPanel header{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:var(--border);font-weight:800}
  #aiPanel .msgs{flex:1;overflow:auto;padding:10px}
  .bubble{max-width:86%;padding:10px 12px;border-radius:12px;margin:6px 0;box-shadow:0 4px 12px rgba(0,0,0,.25)}
  .bubble.user{background:linear-gradient(180deg,var(--accent),transparent); color:#041a16; align-self:flex-end}
  .bubble.ai{background:var(--bubble-ai-bg); border:1px solid var(--bubble-ai-border); color:var(--bubble-ai-text)}
  .result-card{border:var(--border);border-radius:12px;padding:10px;margin:8px 0;background:linear-gradient(180deg,var(--panel),var(--panel-2))}
  .result-row{display:grid;grid-template-columns:80px 1fr;gap:10px;align-items:center}
  .result-thumb{width:80px;height:80px;border-radius:10px;background:linear-gradient(180deg,var(--img1),var(--img2));border:var(--border)}
  #aiPanel .inputrow{display:flex;gap:8px;padding:10px;border-top:var(--border)}
  #aiInput{flex:1;background:var(--panel-2);border:var(--border);border-radius:10px;padding:10px;color:var(--text)}
  .mic{padding:8px 10px;border-radius:10px;border:var(--border);background:var(--panel-2);cursor:pointer}

/* --- Sapali patches v3 --- */
header{position:sticky;top:0;z-index:20}
.bottom-nav{position:sticky;bottom:0;z-index:20}
@supports (position: sticky){
  body{padding-bottom:68px;}
}
.prod-close{position:sticky;top:8px;margin-left:auto}
#aiPanel .inputrow{align-items:center;flex-wrap:wrap}

</style>
<style id="spec-swiper-style">
.img-cell{position:relative;width:400px;height:300px;border:1px solid #333;border-radius:10px;background:#0b0f14;overflow:hidden}
.img-cell .slide{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:#0b0f14}
.img-cell .slide.active{display:flex}
.img-cell img{max-width:100%;max-height:100%;object-fit:contain}
.img-cell .nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer;user-select:none}
.img-cell .nav.left{left:6px}
.img-cell .nav.right{right:6px}
.img-cell .zoom{position:absolute;right:6px;top:6px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;padding:4px 6px;cursor:pointer}
</style>
</head>
<body class="light">
<header>
<div class="topline">
<div class="logo"></div>
<div class="brand" id="brandAI" onclick="toggleAI(true)">Sapali AI</div>
<div class="toolbar">
<!-- Ngôn ngữ & Theme trên cùng 1 cụm, tiết kiệm diện tích -->
<div class="seg" id="langSeg">
<button class="active" data-lang="vi">VI</button>
<button data-lang="en">EN</button>
</div>
<div class="seg">
<button id="themeDark">Dark</button>
<button class="active" id="themeLight">Light</button>
</div>
</div>
</div>
<!-- Search (mobile) -->
<div id="searchMobile">
<input id="q_m" placeholder="Tìm kiếm… (mã sản phẩm, từ khoá)"/>
<button class="btn" id="btnSearch_m">Tìm kiếm</button>
<button class="btn ghost" id="btnCamera">Chụp ảnh</button>
</div>
<!-- Left nav (desktop) -->
<div id="leftNav">
<div class="vtab active" data-target="tab-products" title="Sản phẩm">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><rect height="6" rx="2" width="18" x="3" y="4"></rect><rect height="6" rx="2" width="18" x="3" y="14"></rect></svg>
<div>Sản phẩm</div>
</div>
<div class="vtab" data-target="tab-spec" title="Spec">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><path d="M4 5h10l6 6v8a2 2 0 0 1-2 2H4z"></path><path d="M14 5v6h6"></path></svg>
<div>Spec</div>
</div>
<div class="vtab" data-target="tab-po" title="PO">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><path d="M6 4h9l3 3v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path><path d="M8 12h8M8 16h8M8 8h5"></path></svg>
<div>PO</div>
</div>
<div class="vtab" data-target="tab-admin" title="Admin">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><circle cx="9" cy="7" r="3"></circle><path d="M2 21v-1a6 6 0 0 1 12 0v1"></path><circle cx="17" cy="17" r="3"></circle></svg>
<div>Admin</div>
</div>
</div>
</header>
<!-- Search (desktop top-center, compact) -->
<div id="searchDesktop">
<input id="q_d" placeholder="Tìm kiếm… (mã sản phẩm, từ khoá)"/>
<button class="btn" id="btnSearch_d">Tìm kiếm</button>
<button class="btn ghost" id="btnCamera_d">Chụp ảnh</button>
</div>
<main>
<!-- Products -->
<section class="view active" id="tab-products">
<div class="card">
<b>Danh sách sản phẩm</b>
<div class="scroll-x">
<table>
<thead><tr><th>Mã</th><th>Tên</th><th>Nhóm</th><th>Trạng thái</th></tr></thead>
<tbody id="prodList"></tbody>
</table>
</div>
</div>
<div class="card" id="prodDetailCard" style="display:none">
<b>Chi tiết sản phẩm</b>
<div class="pill" id="prodCode">—</div>
<div id="prodDesc" style="margin:8px 0 4px;color:var(--muted)">—</div>
<div class="card">
<b>Hình ảnh</b>
<div id="imgBox" style="display:flex;gap:10px;flex-wrap:wrap"></div>
</div>
<div class="card">
<b>Thông số / Kích thước</b>
<div class="scroll-x"><table><tbody id="specTbl"></tbody></table></div>
</div>
<div class="card">
<b>BOM linh kiện (dạng hàng ngang)</b>
<div class="scroll-x">
<table>
<thead><tr><th>Cấp</th><th>Mã</th><th>SL / cha</th><th>Ghi chú</th></tr></thead>
<tbody id="bomTbl"></tbody>
</table>
</div>
</div>
</div>
</section>
<!-- Spec -->
<section class="view" id="tab-spec">
<div class="card" id="specOfficialCard">
<div style="display:flex;gap:12px;align-items:center;justify-content:flex-start;">
<button class="btn" id="btnOpenSpecUpload">Cập nhật dữ liệu</button>
<b>Spec — dữ liệu hiện hành</b>
</div>
<div class="scroll-x">
<table class="spec-table" style="min-width:1200px">
<colgroup>
<col style="width:120px"/><col style="width:160px"/><col style="width:120px"/>
<col style="width:80px"/><col style="width:90px"/><col style="width:140px"/>
<col style="width:90px"/><col style="width:90px"/><col style="width:120px"/>
<col style="width:160px"/><col style="width:140px"/><col style="width:320px"/><col style="width:240px"/>
</colgroup>
<thead>
<tr>
<th rowspan="2">Khách hàng</th>
<th rowspan="2">Tên hàng</th>
<th colspan="2">Mã tem</th>
<th colspan="2">Kích thước sp</th>
<th rowspan="2">Vật liệu</th>
<th colspan="2">Tỷ trọng lý thuyết</th>
<th rowspan="2">Gia công</th>
<th rowspan="2">Hình ảnh</th>
<th rowspan="2">Tổng thanh/pllt</th>
<th rowspan="2">Quy cách pallet</th>
<th rowspan="2">Ghi chú</th>
</tr>
<tr>
<th>Tem 1</th><th>Tem 2</th>
<th>Inc</th><th>mm</th>
<th>(kg/m)</th><th>(kg/pcs)</th>
</tr>
</thead>
<tbody id="specOfficialTbl"><tr><td colspan="14" style="color:var(--muted)">Chưa có dữ liệu</td></tr></tbody>
</table>
</div>
</div>
<div class="card" id="specIngestCard" style="display:none">
<b>Spec &amp; BOM — chọn link để Sapali AI tự đọc</b>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
<button class="btn" id="btnPickSpec">Chọn link dữ liệu</button>
<input accept=".xlsx,.xls,.csv" id="fileSpec" multiple="" style="display:none" type="file"/>
<span class="pill">Staging → Duyệt → Cập nhật</span>
<button class="btn ghost" onclick="sg_runDataQA()">Kiểm tra dữ liệu (QA)</button>
</div>
<div class="scroll-x">
<table class="spec-table" style="min-width:1200px">
<colgroup>
<col style="width:120px"/><col style="width:160px"/><col style="width:120px"/>
<col style="width:80px"/><col style="width:90px"/><col style="width:140px"/>
<col style="width:90px"/><col style="width:90px"/><col style="width:120px"/>
<col style="width:160px"/><col style="width:140px"/><col style="width:320px"/><col style="width:240px"/>
</colgroup>
<thead>
<tr>
<th rowspan="2">Khách hàng</th>
<th rowspan="2">Tên hàng</th>
<th colspan="2">Mã tem</th>
<th colspan="2">Kích thước sp</th>
<th rowspan="2">Vật liệu</th>
<th colspan="2">Tỷ trọng lý thuyết</th>
<th rowspan="2">Gia công</th>
<th rowspan="2">Hình ảnh</th>
<th rowspan="2">Tổng thanh/pllt</th>
<th rowspan="2">Quy cách pallet</th>
<th rowspan="2">Ghi chú</th>
</tr>
<tr>
<th>Tem 1</th><th>Tem 2</th>
<th>Inc</th><th>mm</th>
<th>(kg/m)</th><th>(kg/pcs)</th>
</tr>
</thead>
<tbody id="ingestTbl"></tbody>
</table>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
<button class="btn" id="btnSpecApprove">Approval</button>
<button class="btn ghost" id="btnSpecClear">Xoá staging</button>
<span class="pill" id="specCount">0 dòng staging</span>
</div>
</div>
<div class="card" id="specExtraCard"><b>Thông tin bổ sung (ngày lập, chữ ký, địa điểm)</b><div id="specExtraBox" style="margin-top:8px;display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:8px"></div></div></section>
<!-- PO -->
<section class="view" id="tab-po">
<div class="card">
<b>Đọc PO tự động</b>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
<button class="btn" id="btnPickPO">Chọn link PO</button>
<input accept=".xlsx,.xls,.csv,.pdf,image/*" id="filePO" style="display:none" type="file"/>
<span class="pill">AI đọc mã &amp; số lượng → nổ BOM</span>
</div>
</div>
<div class="card">
<b>Danh sách linh kiện cần mua (tổng hợp)</b>
<div class="scroll-x">
<table>
<thead><tr><th>Mã linh kiện</th><th>Tổng số cần</th><th>Chi tiết đơn nhỏ</th></tr></thead>
<tbody id="reqTbl"></tbody>
</table>
</div>
<div style="margin-top:8px"><button class="btn">Xuất Excel</button></div>
</div>
</section>
<!-- Admin -->
<section class="view" id="tab-admin">
<div class="card">
<b>Quản lý người dùng</b>
<div style="margin:8px 0"><button class="btn">+ Thêm user</button></div>
<div class="scroll-x">
<table>
<thead><tr><th>Tên</th><th>Email</th><th>Vai trò</th><th>Hành động</th></tr></thead>
<tbody id="userTbl"></tbody>
</table>
</div>
</div>
<div class="card">
<b>Đào tạo Sapali Group AI</b>
<p style="color:var(--muted);margin:6px 0">Feed Excel/PDF/Ảnh hoặc link; AI tự parse → chuẩn hoá → index; hỗ trợ nhiều profile dữ liệu.</p>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn" id="btnPickTrain">Chọn link dữ liệu</button>
<input accept=".xlsx,.xls,.csv,.pdf,image/*" id="fileTrain" multiple="" style="display:none" type="file"/>
<button class="btn ghost">Tạo profile</button>
</div>
</div>
</section>
</main>
<!-- Bottom nav (mobile) -->
<nav class="bottom-nav" id="bottomNav">
<div class="btab active" data-target="tab-products" title="Sản phẩm">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><rect height="6" rx="2" width="18" x="3" y="4"></rect><rect height="6" rx="2" width="18" x="3" y="14"></rect></svg>
<div>Sản phẩm</div>
</div>
<div class="btab" data-target="tab-spec" title="Spec">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><path d="M4 5h10l6 6v8a2 2 0 0 1-2 2H4z"></path><path d="M14 5v6h6"></path></svg>
<div>Spec</div>
</div>
<div class="btab" data-target="tab-po" title="PO">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><path d="M6 4h9l3 3v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path><path d="M8 12h8M8 16h8M8 8h5"></path></svg>
<div>PO</div>
</div>
<div class="btab" data-target="tab-admin" title="Admin">
<svg fill="none" stroke="currentColor" stroke-width="1.7" viewbox="0 0 24 24"><circle cx="9" cy="7" r="3"></circle><path d="M2 21v-1a6 6 0 0 1 12 0v1"></path><circle cx="17" cy="17" r="3"></circle></svg>
<div>Admin</div>
</div>
</nav>
<!-- Camera/Gallery Modal -->
<div class="modal" id="camModal">
<div class="card box">
<b>Chọn nguồn ảnh</b>
<div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
<button class="btn" id="btnCam">Chụp ảnh mới</button>
<button class="btn ghost" id="btnGallery">Chọn ảnh từ máy</button>
<button class="btn ghost" id="btnCloseCam">Đóng</button>
</div>
</div>
</div>
<input accept="image/*" capture="environment" id="fileCam" style="display:none" type="file"/>
<input accept="image/*" id="fileGallery" style="display:none" type="file"/>
<!-- AI PANEL -->
<div id="aiPanel">
<header>
<div style="display:flex;align-items:center;gap:10px">
<div class="logo"></div><div>Sapali AI</div>
</div>
<div style="margin-left:auto"><button class="btn ghost" onclick="toggleAI(false)">Đóng</button></div>
</header>
<div class="msgs" id="aiMsgs">
<div class="bubble ai">Xin chào! Tôi là Sapali Group AI. Gõ mã, dán link file hoặc nhấn mic để hỏi về <b>sản phẩm/spec/BOM</b>. Tôi trả lại <b>tên, mã, spec, hình ảnh</b> kèm nguồn.</div>
</div>
<div class="inputrow" style="display:flex;gap:8px;padding:10px;border-top:var(--border)">
<input id="aiInput" placeholder="Hỏi Sapali Group AI… (ví dụ: ABC-001, BOM của ABC, ảnh này là mã nào?)" style="flex:1;background:var(--panel-2);border:var(--border);border-radius:10px;padding:10px;color:var(--text)"/>
<button class="mic" onclick="speakDemo()" style="padding:8px 10px;border-radius:10px;border:var(--border);background:var(--panel-2);cursor:pointer" title="Nói (demo)">🎤</button>
<button class="btn" onclick="sendAI()">Gửi</button>
</div>
</div>
<div id="imgFullscreen" style="position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000"><div style="position:relative;max-width:92vw;max-height:92vh"><img id="imgFullscreenImg" style="max-width:92vw;max-height:92vh;object-fit:contain;border-radius:8px"/><button id="imgFsClose" style="position:absolute;right:-8px;top:-48px;padding:8px 12px;border-radius:8px;border:0;background:#fff;color:#000;font-weight:800;cursor:pointer">✕</button></div></div><script>
let SG_SPEC_FOOTER = [];
function extractFooterFromSheet(XLSX, ws){
  SG_SPEC_FOOTER = [];
  try{
    const aoa = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    if(!aoa || !aoa.length) return;
    const tail = aoa.slice(-25);
    const flat = tail.map(r=> r.map(c=>String(c||'').trim()).filter(Boolean).join(' ')).filter(Boolean);
    const seen = new Set();
    function pushUnique(label, value){
      const s = label + ': ' + value;
      if(value && !seen.has(s)){ SG_SPEC_FOOTER.push({label, value}); seen.add(s); }
    }
    flat.forEach(line=>{
      if(/(ha noi|hà nội|hcm|ho chi minh|bắc ninh|bac ninh|haiphong|hai phong)/i.test(line) && /(ngay|ngày|date)/i.test(line)){
        pushUnique('Địa điểm / Ngày', line);
      }
      if(/(ngay|ngày)\s*\d{1,2}/i.test(line)){
        pushUnique('Ngày', line);
      }
      if(/(nguoi lap|người lập|prepared by|prepared)/i.test(line)){
        pushUnique('Người lập', line);
      }
      if(/(kiem tra|kiểm tra|checked by|checked)/i.test(line)){
        pushUnique('Kiểm tra', line);
      }
      if(/(phe duyet|phê duyệt|approved by|approved)/i.test(line)){
        pushUnique('Phê duyệt', line);
      }
      if(/(ky|ký|signature|sign)/i.test(line)){
        pushUnique('Chữ ký', line);
      }
    });
  }catch(e){}
}
function renderFooterBox(){
  const box = document.getElementById('specExtraBox');
  if(!box) return;
  if(!SG_SPEC_FOOTER.length){ box.innerHTML = '<div style="color:var(--muted)">Chưa có thông tin bổ sung</div>'; return; }
  box.innerHTML = SG_SPEC_FOOTER.map(it=>`<div class="pill"><b>${it.label}:</b> ${it.value}</div>`).join('');
}
</script><style id="patch-v2-css">.ai-pop{position:relative;display:inline-block}.ai-pop .menu{position:absolute;left:0;bottom:48px;background:#fff;border:1px solid #e6e9ef;border-radius:12px;box-shadow:0 8px 24px rgba(16,24,40,.12);padding:6px;width:220px;display:none;z-index:9999}.ai-pop.open .menu{display:block}.ai-pop .mi{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer}.ai-pop .mi:hover{background:#f5f7fa}.ai-pop .mi i{width:22px;text-align:center}#aiPlusBtn{width:40px;height:40px;min-width:40px;border-radius:12px;border:1px solid #e6e9ef;background:#fff;box-shadow:0 2px 8px rgba(16,24,40,.06);margin-right:8px}#aiAttachChip{display:none;align-items:center;gap:8px;background:#fff;border:1px solid #e6e9ef;border-radius:12px;padding:6px 8px;margin-right:8px;box-shadow:0 2px 8px rgba(16,24,40,.06)}#aiAttachChip.show{display:flex}#aiAttachChip img{width:36px;height:28px;object-fit:cover;border-radius:8px;border:1px solid #e6e9ef}#aiAttachChip .chip-name{max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#475467;font-size:12px}#aiAttachChip .chip-btn{border:1px solid #e6e9ef;background:#f9fafb;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}#aiAttachChip .chip-x{width:28px;height:28px;border-radius:8px;border:1px solid #e6e9ef;background:#fff;cursor:pointer}.po-hint{font-size:12px;color:#667085}.po-suggest{padding:4px 8px;border-radius:8px;border:1px solid #e6e9ef;background:#f5f7fa;cursor:pointer}</style><script id="patch-v2-js">(function(){var bar=document.getElementById('aiInputBar')||document.querySelector('.inputrow');if(bar){var mic=bar.querySelector('.mic');if(mic&&mic.textContent.trim()==='🎤')mic.remove();var plus=document.getElementById('aiPlusBtn');if(!plus){plus=document.createElement('button');plus.id='aiPlusBtn';plus.title='Thêm…';plus.textContent='+';bar.insertBefore(plus,bar.firstChild)}var chip=document.getElementById('aiAttachChip');if(!chip){chip=document.createElement('div');chip.id='aiAttachChip';chip.innerHTML='<img alt="preview"><span class="chip-name"></span><button class="chip-btn" id="aiChipDetect">Nhận diện ảnh</button><button class="chip-x" id="aiChipRemove">✕</button>';plus.after(chip)}var attach={file:null,url:null};function renderChip(){if(!attach.file){chip.classList.remove('show');return}chip.classList.add('show');chip.querySelector('img').src=attach.url;chip.querySelector('.chip-name').textContent=attach.file.name||'image'}function clearChip(){attach={file:null,url:null};renderChip()}if(!plus.parentElement.classList.contains('ai-pop')){var wrap=document.createElement('div');wrap.className='ai-pop';plus.replaceWith(wrap);wrap.appendChild(plus);var menu=document.createElement('div');menu.className='menu';menu.innerHTML='<div class="mi" data-act="camera"><i>📷</i><span>Chụp ảnh</span></div><div class="mi" data-act="gallery"><i>🖼️</i><span>Chọn ảnh từ thư viện</span></div><div class="mi" data-act="file"><i>📎</i><span>Đính kèm file</span></div>';wrap.appendChild(menu);plus.onclick=function(e){e.stopPropagation();wrap.classList.toggle('open')};document.addEventListener('click',()=>wrap.classList.remove('open'));var cam=document.createElement('input');cam.type='file';cam.accept='image/*';cam.capture='environment';cam.style.display='none';document.body.appendChild(cam);var gal=document.createElement('input');gal.type='file';gal.accept='image/*';gal.style.display='none';document.body.appendChild(gal);var any=document.createElement('input');any.type='file';any.style.display='none';document.body.appendChild(any);function setFile(f){if(!f)return;var r=new FileReader();r.onload=()=>{attach={file:f,url:r.result};renderChip()};r.readAsDataURL(f)}cam.onchange=function(){setFile(cam.files[0]);cam.value=''};gal.onchange=function(){setFile(gal.files[0]);gal.value=''};any.onchange=function(){setFile(any.files[0]);any.value=''};menu.addEventListener('click',function(e){var it=e.target.closest('.mi');if(!it)return;var act=it.getAttribute('data-act');if(act==='camera')cam.click();if(act==='gallery')gal.click();if(act==='file')any.click();wrap.classList.remove('open')})}document.getElementById('aiChipRemove').onclick=clearChip;document.getElementById('aiChipDetect').onclick=function(){if(attach.file&&typeof window.handleImageFile==='function'){window.handleImageFile(attach.file).then(clearChip).catch(clearChip)}else alert('Chưa sẵn sàng nhận diện ảnh.')};var input=document.getElementById('aiInput')||bar.querySelector('input,textarea');var send=document.getElementById('aiSend')||bar.querySelector('button.send')||bar.querySelector('button:last-child');function needVision(t){t=(t||'').toLowerCase();return/đây là|sản phẩm nào|nhận diện|định danh|tìm( |$)/.test(t)}if(send){send.addEventListener('click',function(){if(attach.file&&needVision(input&&(input.value||input.innerText||''))){if(typeof window.handleImageFile==='function'){window.handleImageFile(attach.file).then(clearChip).catch(clearChip)}}},true)}}
(function(){function ready(fn){if(document.readyState!='loading')fn();else document.addEventListener('DOMContentLoaded',fn)}function parsePack(s){if(!s)return 0;var m=String(s).match(/(\d[\d\.,]*)\s*(pcs|cây|thanh|pc)/i);if(m)return parseInt(m[1].replace(/[\.,]/g,''),10)||0;var n=parseInt(String(s).replace(/\D/g,''),10);return n||0}function specMap(){var map={},arr=window.SG_SPEC_FINAL||window.DEMO_SPEC||[];arr.forEach(function(it){var code=it.code||it.product||it.name||it['MÃ']||it['mã']||it['Sản phẩm'];var pack=it['TỔNG THANH/PLLT']||it['Tổng thanh/pllt']||it['Tổng/PLT']||it['Đóng gói']||it.total||it.pack;var p=parsePack(pack);if(code)map[String(code).trim()]={pack:p,raw:pack}});return map}function enhance(){var tbl=document.getElementById('reqTbl');if(!tbl)return;var spec=specMap();tbl.querySelectorAll('tr').forEach(function(tr){if(tr._poEnh)return;tr._poEnh=true;var code=(tr.querySelector('td b')&&tr.querySelector('td b').textContent.trim())||tr.getAttribute('data-po-code')||'';var pack=spec[code]&&spec[code].pack;var qtyInput=tr.querySelector('.po-qty');if(!qtyInput){var cell=document.createElement('td');cell.innerHTML='<input type="number" class="po-qty" min="0" step="1" style="width:100px">';tr.appendChild(cell);qtyInput=cell.firstChild}var hintCell=document.createElement('td');hintCell.innerHTML= pack? '<span class="po-hint">Định mức pack: <b>'+pack+'</b></span> <button class="po-suggest">Gợi ý</button>' : '<span class="po-hint">Chưa có định mức</span>';tr.appendChild(hintCell);var btn=hintCell.querySelector('.po-suggest');if(btn){btn.addEventListener('click',function(){var cur=parseInt(qtyInput.value||'0',10)||0;var base=pack||0;if(!base){alert('Chưa có định mức cho '+code);return;}var suggested=cur>0?Math.ceil(cur/base)*base:base;qtyInput.value=suggested;qtyInput.dispatchEvent(new Event('change',{bubbles:true}))})}})}ready(function(){enhance();var tbl=document.getElementById('reqTbl');if(tbl)new MutationObserver(enhance).observe(tbl,{childList:true,subtree:true})})})();
(function(){var KEY='sapali_ai_knowledge';try{var cur=localStorage.getItem(KEY);if(!cur||cur==='[]'){var seed=[{q:'Sapali Group làm lĩnh vực chính gì?',a:'Sản xuất linh kiện nhựa/kim loại, gia công cơ khí chính xác, lắp ráp cụm chi tiết.',tags:['onboarding']},{q:'Giờ làm việc và ca kíp?',a:'Giờ hành chính 8:00–17:00 (T2–T6). Ca sản xuất theo lịch xưởng.',tags:['onboarding','HR']},{q:'Quy trình phê duyệt PO?',a:'Nhân viên tạo PO → Trưởng bộ phận duyệt → Mua hàng đặt → Kho nhận → Kế toán đối soát.',tags:['PO','procurement']},{q:'Chính sách bảo hành tiêu chuẩn?',a:'Bảo hành 12 tháng cho sản phẩm lỗi do nhà sản xuất.',tags:['policy']},{q:'Liên hệ nội bộ khi có sự cố máy?',a:'Bảo trì (Ext 115) hoặc trưởng ca. Ghi log sự cố vào CMMS.',tags:['contact','maintenance']},{q:'Chuẩn đặt hàng theo pack là gì?',a:'Đặt theo bội số định mức đóng gói (pack/bo/pallet) để tối ưu.',tags:['PO']},{q:'Kênh báo cáo lỗi chất lượng?',a:'Dùng form NCR trên QMS, gắn ảnh lỗi và mã lô.',tags:['QA']},{q:'Chuẩn an toàn lao động khu gia công?',a:'Bắt buộc PPE: mũ, găng, kính. Huấn luyện an toàn trước ca.',tags:['EHS']},{q:'Quy ước đặt tên mã linh kiện?',a:'Tiền tố nhóm vật liệu (ALU, PVC, BRKT, ...), theo sau là biến thể/size.',tags:['engineering']},{q:'Kênh hỗ trợ CNTT?',a:'IT Helpdesk (helpdesk@sapali.vn) hoặc hotline nội bộ.',tags:['IT']},{q:'Thời gian lưu kho tối đa 1 PO?',a:'Theo FIFO và SLA khách, tối đa 30 ngày nếu chưa xuất.',tags:['warehouse']},{q:'Chuẩn gửi file Spec/BOM?',a:'Excel mẫu chuẩn: tab Spec, tab BOM ngang.',tags:['engineering','spec']},{q:'Xử lý PO gấp?',a:'Đánh dấu URGENT, thông báo trưởng BP Mua hàng, ưu tiên kế hoạch.',tags:['PO']},{q:'Quy trình nhập kho?',a:'Kho kiểm số lượng & chất lượng, dán tem, cập nhật ERP.',tags:['warehouse']},{q:'Liên hệ CSKH?',a:'CSHK (Ext 120) hoặc AM phụ trách.',tags:['sales']}];localStorage.setItem(KEY,JSON.stringify(seed))}}catch(e){} })();})();</script>
<script id="sapali-v3-js">
// ENTER to send
(function(){
  const input = document.getElementById('aiInput');
  function send(){ try{ (window.sendAI||function(){})() }catch(e){} }
  if(input){
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });
  }
  window.toggleAI = function(open){
    const p = document.getElementById('aiPanel');
    if(!p) return;
    p.style.display = open? 'flex':'none';
    document.body.style.overflow = open? 'hidden':'auto';
    if(open){ setTimeout(()=>{ (document.getElementById('aiInput')||{}).focus?.() }, 60); }
  };
})();
// Product detail close
(function(){
  const card = document.getElementById('prodDetailCard');
  if(card && !card.querySelector('.prod-close')){
    const btn = document.createElement('button');
    btn.className = 'btn ghost prod-close'; btn.textContent='Đóng';
    btn.onclick = ()=>{ card.style.display='none'; };
    card.prepend(btn);
  }
})();
// PO: parse files + export
(function(){
  const pickPO = document.getElementById('btnPickPO');
  const filePO = document.getElementById('filePO');
  const reqTbl = document.getElementById('reqTbl');
  if(!pickPO || !filePO || !reqTbl) return;
  const PO_ITEMS = {};
  function render(){ reqTbl.innerHTML = Object.entries(PO_ITEMS).map(([c,i])=>`<tr><td><b>${c}</b></td><td>${i.qty}</td><td>${i.by.map(x=>`${x.src}:${x.qty}`).join(', ')}</td></tr>`).join('') || '<tr><td colspan="3">Chưa có dữ liệu</td></tr>'; }
  function add(c,q,src){ if(!c||!q) return; c=c.toUpperCase(); q=+q||0; (PO_ITEMS[c]||(PO_ITEMS[c]={qty:0,by:[]})).qty+=q; PO_ITEMS[c].by.push({src,qty:q}); }
  function parseText(t,src){ (''+t).split(/[\r\n]+/).forEach(line=>{ const m=line.match(/([A-Z0-9\-]{3,})[^0-9]{0,8}(\d{1,6})(?!\w)/); if(m) add(m[1],m[2],src); }); }
  async function excel(file){ await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=res; s.onerror=()=>rej(); document.head.appendChild(s); }); const ab=await file.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); wb.SheetNames.forEach(n=>{ const aoa=XLSX.utils.sheet_to_json(wb.Sheets[n],{header:1,defval:''}); aoa.forEach((row,i)=>parseText(row.join(' '), `${file.name}#${n}!${i+1}`)); }); }
  async function pdfOrImage(file){
    const ext=(file.name.split('.').pop()||'').toLowerCase();
    if(ext==='pdf'){ await new Promise((res)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js'; s.onload=res; s.onerror=res; document.head.appendChild(s);}); if(window.pdfjsLib){ const buf=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:buf}).promise; let all=''; for(let p=1;p<=pdf.numPages;p++){ const pg=await pdf.getPage(p); const tc=await pg.getTextContent(); all+=tc.items.map(i=>i.str).join(' ')+'\\n'; } parseText(all,file.name); return; } }
    await new Promise((res)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'; s.onload=res; s.onerror=res; document.head.appendChild(s);});
    if(window.Tesseract){ const w=await Tesseract.createWorker(); await w.loadLanguage('eng'); await w.initialize('eng'); const {data}=await w.recognize(file); await w.terminate(); parseText(data.text,file.name); }
  }
  pickPO.onclick = ()=> filePO.click();
  filePO.onchange = async (e)=>{ const fs=[...e.target.files||[]]; for(const f of fs){const ext=(f.name.split('.').pop()||'').toLowerCase(); if(['xls','xlsx','csv'].includes(ext)) await excel(f); else await pdfOrImage(f);} render(); };
  // export
  const exportBtn = document.querySelector('#tab-po .card button.btn.exportPO');
  if(exportBtn){ exportBtn.onclick = async ()=>{ if(!Object.keys(PO_ITEMS).length) return alert('Chưa có dữ liệu'); await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=res; s.onerror=()=>rej(); document.head.appendChild(s); }); const rows=[['Mã','Tổng SL']].concat(Object.entries(PO_ITEMS).map(([c,i])=>[c,i.qty])); const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'PO'); const base64=XLSX.write(wb,{bookType:'xlsx',type:'base64'}); const a=document.createElement('a'); a.href='data:application/octet-stream;base64,'+base64; a.download='PO_tong_hop.xlsx'; a.click(); }; }
})();
// Admin: add user + training
(function(){
  const userTbl=document.getElementById('userTbl');
  const addBtn=document.querySelector('#tab-admin .card .btn.addUser');
  if(userTbl && addBtn){
    if(!userTbl.dataset.seeded){
      userTbl.dataset.seeded='1';
      const s=[['Nguyễn An','an@sapali.vn','Admin'],['Trần Bình','binh@sapali.vn','Kế hoạch'],['Phạm Chi','chi@sapali.vn','Mua hàng'],['Lê Dũng','dung@sapali.vn','Kho'],['Võ Em','em@sapali.vn','QA']];
      userTbl.innerHTML=s.map(x=>`<tr><td>${x[0]}</td><td>${x[1]}</td><td>${x[2]}</td><td><button class="btn ghost btn-del">Xoá</button></td></tr>`).join('');
    }
    addBtn.onclick=()=>{
      const m=document.createElement('div'); m.className='modal'; m.style.display='flex'; m.innerHTML=`<div class="card box" style="width:min(520px,92vw)"><b>Thêm user</b><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px"><input id="uName" placeholder="Họ tên"><input id="uMail" placeholder="Email"><select id="uRole"><option>Admin</option><option>Kế hoạch</option><option>Mua hàng</option><option>Kho</option><option>QA</option></select></div><div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end"><button class="btn ghost" id="uCancel">Huỷ</button><button class="btn" id="uOk">Lưu</button></div></div>`; document.body.appendChild(m); m.onclick=(e)=>{ if(e.target===m) m.remove(); }; m.querySelector('#uCancel').onclick=()=>m.remove(); m.querySelector('#uOk').onclick=()=>{ const n=m.querySelector('#uName').value.trim(); const mail=m.querySelector('#uMail').value.trim(); const r=m.querySelector('#uRole').value; if(!n||!mail){alert('Nhập đủ họ tên & email');return;} userTbl.insertAdjacentHTML('beforeend', `<tr><td>${n}</td><td>${mail}</td><td>${r}</td><td><button class="btn ghost btn-del">Xoá</button></td></tr>`); m.remove(); }; };
    userTbl.addEventListener('click',(e)=>{ if(e.target.classList.contains('btn-del')) e.target.closest('tr').remove(); });
  }
  const trainBtn=document.getElementById('btnPickTrain'); const trainFile=document.getElementById('fileTrain');
  if(trainBtn && trainFile){ const qa=document.createElement('button'); qa.className='btn ghost'; qa.textContent='Đào tạo AI (Q/A)'; trainBtn.parentElement.appendChild(qa);
    trainBtn.onclick=()=>trainFile.click();
    trainFile.onchange=(e)=>{ const files=[...e.target.files||[]]; const KEY='sapali_ai_knowledge_files'; const cur=JSON.parse(localStorage.getItem(KEY)||'[]'); files.forEach(f=>cur.push({name:f.name,size:f.size,type:f.type})); localStorage.setItem(KEY, JSON.stringify(cur)); alert('Đã ghi nhớ '+files.length+' tệp (demo).'); };
    qa.onclick=()=>{ const m=document.createElement('div'); m.className='modal'; m.style.display='flex'; m.innerHTML=`<div class="card box" style="width:min(600px,92vw)"><b>Đào tạo Q/A nhanh</b><div style="display:grid;gap:8px;margin-top:8px"><input id="qaQ" placeholder="Câu hỏi (Q)"><textarea id="qaA" rows="4" placeholder="Câu trả lời (A)"></textarea></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn ghost" id="cancel">Huỷ</button><button class="btn" id="save">Lưu</button></div></div>`; document.body.appendChild(m); m.onclick=(e)=>{ if(e.target===m) m.remove(); }; m.querySelector('#cancel').onclick=()=>m.remove(); m.querySelector('#save').onclick=()=>{ const q=m.querySelector('#qaQ').value.trim(); const a=m.querySelector('#qaA').value.trim(); if(!q||!a){alert('Nhập Q và A');return;} const KEY='sapali_ai_knowledge'; const cur=JSON.parse(localStorage.getItem(KEY)||'[]'); cur.push({q,a,ts:Date.now()}); localStorage.setItem(KEY, JSON.stringify(cur)); m.remove(); alert('Đã lưu Q/A (localStorage).'); }; };
})();
</script>


<!-- ==== AI Settings (Floating) – Non-intrusive ==== -->
<div id="aiSettingsBtn" style="position:fixed;right:16px;bottom:16px;z-index:9999;">
  <button style="padding:10px 14px;border-radius:999px;border:1px solid #ddd;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15);cursor:pointer">
    ⚙️ AI Settings
  </button>
</div>
<div id="aiSettingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:10000;align-items:center;justify-content:center;">
  <div style="background:#fff;min-width:320px;max-width:520px;padding:16px 18px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.25)">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
      <b>Cài đặt AI</b>
      <button id="aiSettingsClose" style="border:0;background:transparent;font-size:18px;cursor:pointer">✖</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <label style="display:flex;gap:8px;align-items:center">
        <input id="aiOnlineToggle" type="checkbox" checked>
        <span>Bật "Online Free" (kinh tế, wiki, tin tức)</span>
      </label>
      <label> Tone trả lời
        <select id="aiTone" style="width:100%">
          <option value="gpt" selected>GPT-like (mặc định khi Online)</option>
          <option value="biz">Doanh nghiệp</option>
          <option value="tech">Kỹ thuật</option>
        </select>
      </label>
      <label> Cache (giờ)
        <input id="aiCacheHours" type="number" value="6" min="0" style="width:100%">
      </label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="aiSaveCfg" style="padding:8px 12px;border:1px solid #ddd;background:#f7f7f7;border-radius:8px;cursor:pointer">Lưu</button>
    </div>
    <div style="margin-top:10px;font-size:12px;color:#555">Mặc định: Online Free bật, Tone = GPT-like, Cache = 6 giờ.</div>
  </div>
</div>


<script>
/* ================= Sapali AI – Router + Free Engines + GPT-like Composer ================= */
(function(){
  // ---- State & settings ----
  window.SAPALI_AI_CFG = JSON.parse(localStorage.getItem('sapali_ai_cfg')||'{}');
  if(!SAPALI_AI_CFG.version){
    SAPALI_AI_CFG = { online:true, tone:'gpt', cacheHours:6, version:'v1' };
  function saveCfg(cfg){
    localStorage.setItem('sapali_ai_cfg', JSON.stringify(cfg));
    window.SAPALI_AI_CFG = cfg;
  }

  // ---- Floating settings modal ----
  const btn = document.getElementById('aiSettingsBtn');
  const modal = document.getElementById('aiSettingsModal');
  const closeBtn = document.getElementById('aiSettingsClose');
  if(btn && modal && closeBtn){
    btn.onclick = ()=>{ 
      modal.style.display='flex';
      const tgl = document.getElementById('aiOnlineToggle');
      const tone = document.getElementById('aiTone');
      const cache = document.getElementById('aiCacheHours');
      if(tgl) tgl.checked = !!SAPALI_AI_CFG.online;
      if(tone) tone.value = SAPALI_AI_CFG.tone || 'gpt';
      if(cache) cache.value = SAPALI_AI_CFG.cacheHours ?? 6;
    };
    closeBtn.onclick = ()=> modal.style.display='none';
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.style.display='none'; });
    const save = document.getElementById('aiSaveCfg');
    if(save){
      save.onclick = ()=>{
        const tgl = document.getElementById('aiOnlineToggle');
        const tone = document.getElementById('aiTone');
        const cache = document.getElementById('aiCacheHours');
        saveCfg({ online: tgl?.checked ?? true, tone: tone?.value || 'gpt', cacheHours: Math.max(0, +(cache?.value||6)|0), version:'v1' });
        alert('Đã lưu cài đặt AI.');
        modal.style.display='none';
      };
    }
  }

  // ---- Helpers ----
  function norm(s){ return (s||'').toString().trim(); }
  function pushBubble(who, text, html=false){
    const box = document.getElementById('aiMsgs'); if(!box) return;
    const b = document.createElement('div'); b.className = 'bubble '+(who==='user'?'user':'ai');
    if(html){ b.innerHTML = text; } else { b.textContent = text; }
    box.appendChild(b); box.scrollTop = box.scrollHeight;
  }
  function showUser(msg){ pushBubble('user', msg); }
  function showAI(msg, html=false){ pushBubble('ai', msg, html); }

  // ---- Cache via localStorage ----
  async function cachedFetch(url, ttlHours){
    const KEY='sapali_cache_v1';
    const now = Date.now();
    let store;
    try{ store = JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ store={}; }
    const hit = store[url];
    if(hit && (now - hit.ts) < (ttlHours*3600*1000)) return hit.data;
    const res = await fetch(url);
    let data;
    try{ data = await res.json(); }
    catch(e){ data = { raw: await res.text() }; }
    store[url] = { ts: now, data };
    localStorage.setItem(KEY, JSON.stringify(store));
    return data;
  }

  // ---- Intent detection ----
  function detectIntent(q){
    const s = (q||'').toLowerCase();
    if(/\b(ecn|wi|bom|dept|pu|po|model|mã|sku|tem|spec|linh kiện|bộ phận)\b/i.test(s)) return {type:'internal'};
    if(/\b(tỷ giá|ty gia|exchange|usd|vnd|eur|jpy|cpi|gdp|lạm phát|lai suat|interest|inflation)\b/i.test(s)) return {type:'economy'};
    if(/\b(tin|news|bản tin|thị trường|market)\b/i.test(s)) return {type:'news'};
    if(/\b(là gì|định nghĩa|wikipedia|wiki|tiểu sử|history|lịch sử|khái niệm)\b/i.test(s)) return {type:'wiki'};
    if(/[0-9][\s\+\-\*\/\(\)\.]+[0-9]/.test(s)) return {type:'math'};
    if(/[A-Z0-9]{2,}[-_][A-Z0-9]{2,}/.test(q)) return {type:'internal'};
    return {type: SAPALI_AI_CFG.online ? 'wiki' : 'internal'};

  
  // ---- Query Planner (understands long VN sentences; slots: currency, pair, topic) ----
  function planQuery(q){
    const orig = String(q||'');
    const s = orig.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const cleaned = s.replace(/[!?]+/g,' ').replace(/\s+/g,' ').trim();
    let pair = null; const m1 = cleaned.match(/\b([a-z]{3})\s*[/ -]?\s*([a-z]{3})\b/); if(m1){ pair=(m1[1]+'/'+m1[2]).toUpperCase(); }
    const econKW = /(ty gia|tygia|exchange|usd|vnd|eur|jpy|cpi|gdp|lam phat|lai suat|interest|inflation)/;
    const isEcon = econKW.test(cleaned);
    const newsKW = /(tin|news|ban tin|thi truong|market)/; const isNews = newsKW.test(cleaned);
    const wikiKW = /(la gi|dinh nghia|wikipedia|wiki|tieu su|history|lich su|khai niem)/;
    const isWiki = wikiKW.test(cleaned) || (!isEcon && !isNews && /\s/.test(cleaned));
    const isInternal = /\b(ecn|wi|bom|dept|pu|po|model|ma|sku|tem|spec|linh kien|bo phan)\b/.test(cleaned) || /[A-Z0-9]{2,}[-_][A-Z0-9]{2,}/.test(orig);
    let topic = orig.trim(); topic = topic.replace(/^\s*(hoi|tim|vui long|lam on)\s+/i,''); topic = topic.replace(/\b(trong he thong|xem co khong|co khong)\b/ig,'').trim();
    let intent='internal'; if(isInternal) intent='internal'; else if(isEcon) intent='economy'; else if(isNews) intent='news';
    else if(/\d[\s\+\-\*\/\(\)\.]+\d/.test(orig)) intent='math'; else intent=(window.SAPALI_AI_CFG&&SAPALI_AI_CFG.online)?'wiki':'internal';
    return { intent, cleaned, pair, topic };

  // ---- Engines (FREE) ----
  async function econEngine(query){
    const m = query.toUpperCase().match(/\b([A-Z]{3})[\/\s\-]*([A-Z]{3})\b/);
    const base = (m && m[1]) || 'USD';
    const sym  = (m && m[2]) || 'VND';
    const url = `https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=${encodeURIComponent(sym)}`;
    const data = await cachedFetch(url, SAPALI_AI_CFG.cacheHours||1);
    if(!data || !data.rates || !data.rates[sym]) return "Chưa lấy được tỷ giá.";
    const rate = data.rates[sym];
    return composeAnswer({
      title:`Tỷ giá ${base}/${sym}`,
      bullets:[`Tỷ giá hiện tại: **${Number(rate).toLocaleString()}**`, `Nguồn: exchangerate.host (free)`],
      note:`Gợi ý: “CPI Việt Nam”, “GDP Japan 2023”, “Lãi suất Mỹ hiện tại”…`
    });
  }

  async function wbEngine(query){
    const map = { gdp:'NY.GDP.MKTP.CD', inflation:'FP.CPI.TOTL.ZG', cpi:'FP.CPI.TOTL.ZG', interest:'FR.INR.LEND' };
    let ind='NY.GDP.MKTP.CD', country='VNM';
    if(/inflation|l[ạa]m ph[aá]t|cpi/i.test(query)) ind=map.inflation;
    if(/interest|l[ãa]i su[aá]t/i.test(query)) ind=map.interest;
    const cMatch = query.toLowerCase().match(/\b(vietnam|viet nam|japan|jpn|usa|us|china|cn|singapore|sg)\b/);
    if(cMatch){ const c=cMatch[1]; if(/jap|jpn|japan/.test(c)) country='JPN'; else if(/usa|us/.test(c)) country='USA'; else if(/china|cn/.test(c)) country='CHN'; else if(/singapore|sg/.test(c)) country='SGP'; else country='VNM'; }
    const url = `https://api.worldbank.org/v2/country/${country}/indicator/${ind}?format=json&per_page=5`;
    const data = await cachedFetch(url, SAPALI_AI_CFG.cacheHours||24);
    const arr = (data && data[1]) || [];
    if(!arr.length) return "Không lấy được số liệu World Bank.";
    const rows = arr.filter(x=>x.value!=null).slice(0,3).map(x=>`**${x.date}**: ${Number(x.value).toLocaleString()}`);
    return composeAnswer({ title:`World Bank — ${ind} (${country})`, bullets: rows.length? rows : ['Chưa có số liệu hợp lệ'] });
  }

  async function wikiEngine(query){
    async function wikiFetch(lang, title){
      const q = encodeURIComponent(title);
      const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${q}`;
      return await cachedFetch(url, SAPALI_AI_CFG.cacheHours||6);
    }

    const title = String(query).replace(/\b(là gì|la gi|wiki(pedia)?|định nghĩa|dinh nghia)\b/gi,'').trim();
    let data = await wikiFetch('vi', title);
    if(!data || (!data.extract && !data.description)){
      data = await wikiFetch('en', title);
    }
    if(data && (data.extract || data.description)){
      return composeAnswer({
        title: data.title || query,
        body: (data.description? `_${data.description}_\n\n`:'') + (data.extract||''),
        link: (data.content_urls && data.content_urls.desktop) ? data.content_urls.desktop.page : undefined
      });
    }
    return "Chưa tìm thấy mục từ phù hợp trên Wikipedia.";
  }

  async function newsEngine(query){
    const kw = encodeURIComponent(query.replace(/\b(tin|news|bản tin|thị trường)\b/gi,'').trim()||'kinh tế');
    const url = `https://r.jina.ai/http://news.google.com/rss/search?q=${kw}`;
    const raw = await cachedFetch(url, Math.min(1, SAPALI_AI_CFG.cacheHours||1));
    const xml = raw.raw || '';
    const items = [...xml.matchAll(/<item>([\s\S]*?)<\/item>/g)].slice(0,5).map(m=>{
      const t=(m[1].match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)||[])[1] || (m[1].match(/<title>(.*?)<\/title>/)||[])[1] || '';
      const l=(m[1].match(/<link>(.*?)<\/link>/)||[])[1] || '';
      return `• ${t}\n  ${l}`;
    });
    return composeAnswer({ title:`Bản tin nhanh: ${decodeURIComponent(kw)}`, bullets: items.length? items : ['Không đọc được RSS (CORS). Hãy thử lại.'], note:`Nguồn: Google News RSS` }, true);
  }

  async function mathEngine(query){
    try{
      const expr = query.match(/[-+/*()0-9.\s]+/g)?.join('') || '';
      // eslint-disable-next-line no-new-func
      const val = Function(`"use strict"; return (${expr})`)();
      if(!isFinite(val)) throw 0;
      return composeAnswer({ title:'Tính toán', bullets:[`${expr} = **${val}**`] });
    }catch(e){ return "Không tính được biểu thức."; }
  }

  // ---- Composer (GPT-like tone) ----
  function composeAnswer(payload, asHTML=false){
    const tone = SAPALI_AI_CFG.tone || 'gpt';
    const {title, bullets=[], body='', link, note} = payload||{};
    const intro = (tone==='gpt')? "Theo dữ liệu em tổng hợp:" :
                 (tone==='biz')? "Thông tin tổng hợp cho anh/chị:" :
                 "Kết quả phân tích:";
    let out = `**${title||'Kết quả'}**\n${intro}\n`;
    if(body) out += `\n${body}\n`;
    if(bullets && bullets.length) out += '\n' + bullets.map(b=> (typeof b==='string'? `- ${b}`:`- ${JSON.stringify(b)}`)).join('\n') + '\n';
    if(note) out += `\n> _${note}_\n`;
    if(link) out += `\n[Tham khảo](${link})`;
    return asHTML ? out.replace(/\n/g,'<br>') : out;
  }

  // ---- Internal fallback ----
  async function internalEngine(q){
    const KB = JSON.parse(localStorage.getItem('sapali_ai_knowledge')||'[]');
    const hit = KB.find(x=> (x.q||'').toLowerCase().includes(q.toLowerCase()));
    if(hit){ return composeAnswer({ title:'Kiến thức nội bộ', bullets:[hit.a], note:'Nguồn: Sapali KB (localStorage)' }); }
    return 'Em chưa tìm thấy nội dung nội bộ phù hợp. Anh có thể cung cấp mã/Dept/WI/ECN cụ thể hơn không?';
  }

  // ---- Main sendAI (non-breaking) ----
  window.sendAI = async function(){
    const inp = document.getElementById('aiInput');
    const qRaw = (inp && inp.value) ? inp.value : '';
    const q = qRaw.trim(); if(!q) return;
    (function(){ const box=document.getElementById('aiMsgs'); if(box){ const b=document.createElement('div'); b.className='bubble user'; b.textContent=q; box.appendChild(b); box.scrollTop=box.scrollHeight; } })();
    if(inp) inp.value='';
    const plan = (typeof planQuery==='function') ? planQuery(q) : { intent: 'wiki', topic: q };
    const online = !!(window.SAPALI_AI_CFG && SAPALI_AI_CFG.online);
    try{
      let answer='';
      if(plan.intent==='internal'){
        if(typeof internalEngine==='function') answer = await internalEngine(q); else answer = 'Em chưa tìm thấy nội bộ phù hợp.';
      }else if(!online){
        answer = 'Chế độ Offline đang bật — chỉ trả lời nội bộ. Bật "Online Free" để dùng bách khoa/kinh tế.';
      }else if(plan.intent==='economy'){
        if(plan.pair || /t[ỷy]\s*gi[aá]/i.test(q)) answer = await econEngine(q); else answer = await wbEngine(q);
      }else if(plan.intent==='news'){
        answer = await newsEngine(plan.topic||q);
      }else if(plan.intent==='math'){
        answer = await mathEngine(q);
      }else{
        answer = await wikiEngine(plan.topic||q);
      }
      (function(a){ const box=document.getElementById('aiMsgs'); if(box){ const b=document.createElement('div'); b.className='bubble ai'; b.innerHTML=a; box.appendChild(b); box.scrollTop=box.scrollHeight; } })(answer);
    }catch(err){ console.error(err); const box=document.getElementById('aiMsgs'); if(box){ const b=document.createElement('div'); b.className='bubble ai'; b.textContent='Có lỗi khi gọi nguồn miễn phí. Anh thử lại giúp em nhé.'; box.appendChild(b); box.scrollTop=box.scrollHeight; } }
  }
}

})();

// Defensive binding for the Send button in case inline onclick is overridden
(function(){
  try{
    var panel=document.getElementById('aiPanel');
    var btns = panel ? panel.getElementsByTagName('button') : [];
    for(var i=0;i<btns.length;i++){
      var b=btns[i];
      if((b.textContent||'').trim()==='Gửi'){
        b.addEventListener('click', function(ev){ if(window.sendAI) window.sendAI(); }, {capture:true});
      }
    }
  }catch(e){}
})();
</script>


<script id="routerOverrideV1">
(function(){
  if (window.__sapaliRouterOverride) return; 
  window.__sapaliRouterOverride = true;
  function bubble(who, html){
    try{
      var box = document.getElementById('aiMsgs'); if(!box) return;
      var b = document.createElement('div'); b.className='bubble ' + (who==='user'?'user':'ai');
      if(html && /[<>]/.test(html)) { b.innerHTML = html; } else { b.textContent = html; }
      box.appendChild(b); box.scrollTop = box.scrollHeight;
    }catch(e){}
  }
  async function callEngine(plan, q){
    const online = !!(window.SAPALI_AI_CFG && SAPALI_AI_CFG.online);
    if(plan.intent==='internal'){
      if(typeof window.internalEngine === 'function') return await window.internalEngine(q);
      return 'Em chưa tìm thấy nội bộ phù hợp.';
    }
    if(!online){
      return 'Chế độ Offline đang bật — chỉ trả lời nội bộ. Bật "Online Free" để dùng bách khoa/kinh tế.';
    }
    if(plan.intent==='economy'){
      if(plan.pair || /t[ỷy]\s*gi[aá]/i.test(q)) return await window.econEngine(q);
      return await window.wbEngine(q);
    }
    if(plan.intent==='news'){
      return await window.newsEngine(plan.topic||q);
    }
    if(plan.intent==='math'){
      return await window.mathEngine(q);
    }
    return await window.wikiEngine(plan.topic||q);
  }
  window.sendAI = async function(){
    try{
      var inp = document.getElementById('aiInput');
      var q = (inp && inp.value ? inp.value : '').trim();
      if(!q) return;
      bubble('user', q);
      if(inp) inp.value='';
      var plan = (typeof window.planQuery==='function') ? window.planQuery(q) 
                : (typeof window.detectIntent==='function' ? window.detectIntent(q) : {type:'wiki', topic:q});
      if(plan.type && !plan.intent) plan.intent = plan.type;
      var answer = await callEngine(plan, q);
      bubble('ai', answer);
    }catch(err){
      console.error(err);
      bubble('ai', 'Có lỗi khi gọi nguồn miễn phí. Anh thử lại giúp em nhé.');
    }
  };
})();
</script>
<script id="sapali-ai-core">(function(){window.SAPALI_AI_CFG=Object.assign({online:true,tone:'gpt',cacheHours:6},window.SAPALI_AI_CFG||{});function bubble(who,content,isHTML){try{var box=document.getElementById('aiMsgs');if(!box)return;var b=document.createElement('div');b.className='bubble '+(who==='user'?'user':'ai');if(isHTML)b.innerHTML=content;else b.textContent=content;box.appendChild(b);box.scrollTop=box.scrollHeight;}catch(e){}}function norm(s){return(s||'').toString().trim();}async function cachedFetch(url,ttlHours){const KEY='sapali_cache_v1';const now=Date.now();let store={};try{store=JSON.parse(localStorage.getItem(KEY)||'{}');}catch(e){}const hit=store[url];if(hit&&(now-hit.ts)<(ttlHours*3600*1000))return hit.data;const res=await fetch(url);let data;try{data=await res.json();}catch(e){data={raw:await res.text()};}store[url]={ts:now,data};localStorage.setItem(KEY,JSON.stringify(store));return data;}function planQuery(q){const orig=String(q||'');const s=orig.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');const cleaned=s.replace(/[!?]+/g,' ').replace(/\s+/g,' ').trim();let pair=null;const m1=cleaned.match(/\b([a-z]{3})\s*[/ -]?\s*([a-z]{3})\b/);if(m1)pair=(m1[1]+'/'+m1[2]).toUpperCase();const isEcon=/(ty gia|tygia|exchange|usd|vnd|eur|jpy|cpi|gdp|lam phat|lai suat|interest|inflation)/.test(cleaned);const isNews=/(tin|news|ban tin|thi truong|market)/.test(cleaned);const isInternal=/\b(ecn|wi|bom|dept|pu|po|model|ma|sku|tem|spec|linh kien|bo phan)\b/.test(cleaned)||/[A-Z0-9]{2,}[-_][A-Z0-9]{2,}/.test(orig);let intent='internal';if(isInternal)intent='internal';else if(isEcon)intent='economy';else if(isNews)intent='news';else if(/\d[\s\+\-\*\/\(\)\.]+\d/.test(orig))intent='math';else intent=(window.SAPALI_AI_CFG.online?'wiki':'internal');let topic=orig.trim();return{intent,pair,topic};}function compose(p,asHTML=false){const t=(window.SAPALI_AI_CFG.tone||'gpt');const{title,bullets=[],body='',link,note}=p||{};const intro=t==='gpt'?'Theo dữ liệu em tổng hợp:':t==='biz'?'Thông tin tổng hợp cho anh/chị:':'Kết quả phân tích:';let out=`**${title||'Kết quả'}**\n${intro}\n`;if(body)out+=`\n${body}\n`;if(bullets.length)out+='\n'+bullets.map(x=>`- ${x}`).join('\n')+'\n';if(note)out+=`\n> _${note}_\n`;if(link)out+=`\n[Tham khảo](${link})`;return asHTML?out.replace(/\n/g,'<br>'):out;}async function econEngine(q){const m=q.toUpperCase().match(/\b([A-Z]{3})[\/\s\-]*([A-Z]{3})\b/);const base=(m&&m[1])||'USD';const sym=(m&&m[2])||'VND';const url=`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=${encodeURIComponent(sym)}`;const d=await cachedFetch(url,(window.SAPALI_AI_CFG.cacheHours||1));if(!d||!d.rates||!d.rates[sym])return'Chưa lấy được tỷ giá.';const rate=d.rates[sym];return compose({title:`Tỷ giá ${base}/${sym}`,bullets:[`Tỷ giá hiện tại: **${Number(rate).toLocaleString()}**`,'Nguồn: exchangerate.host']},true);}async function wbEngine(q){const map={gdp:'NY.GDP.MKTP.CD',inflation:'FP.CPI.TOTL.ZG',cpi:'FP.CPI.TOTL.ZG',interest:'FR.INR.LEND'};let ind='NY.GDP.MKTP.CD',country='VNM';if(/inflation|l[ạa]m ph[aá]t|cpi/i.test(q))ind=map.inflation;if(/interest|l[ãa]i su[aá]t/i.test(q))ind=map.interest;const c=(q.toLowerCase().match(/\b(vietnam|viet nam|japan|jpn|usa|us|china|cn|singapore|sg)\b/)||[])[1];if(c){country=/jap|jpn|japan/.test(c)?'JPN':/usa|us/.test(c)?'USA':/china|cn/.test(c)?'CHN':/singapore|sg/.test(c)?'SGP':'VNM';}const url=`https://api.worldbank.org/v2/country/${country}/indicator/${ind}?format=json&per_page=5`;const d=await cachedFetch(url,(window.SAPALI_AI_CFG.cacheHours||24));const arr=(d&&d[1])||[];const rows=arr.filter(x=>x.value!=null).slice(0,3).map(x=>`**${x.date}**: ${Number(x.value).toLocaleString()}`);return compose({title:`World Bank — ${ind} (${country})`,bullets:rows.length?rows:['Chưa có số liệu hợp lệ']},true);}async function wikiEngine(q){async function wikiFetch(lang,title){const U=`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;return await cachedFetch(U,(window.SAPALI_AI_CFG.cacheHours||6));}const title=String(q).replace(/\b(là gì|la gi|wiki(pedia)?|định nghĩa|dinh nghia)\b/gi,'').trim();let d=await wikiFetch('vi',title);if(!d||(!d.extract&&!d.description))d=await wikiFetch('en',title);if(d&&(d.extract||d.description)){return compose({title:d.title||q,body:(d.description?`_${d.description}_\n\n`:'')+(d.extract||''),link:(d.content_urls&&d.content_urls.desktop)?d.content_urls.desktop.page:undefined},true);}return'Chưa tìm thấy mục từ phù hợp trên Wikipedia.';}async function newsEngine(q){const kw=encodeURIComponent(q.replace(/\b(tin|news|bản tin|thị trường)\b/gi,'').trim()||'kinh tế');const url=`https://r.jina.ai/http://news.google.com/rss/search?q=${kw}`;const raw=await cachedFetch(url,Math.min(1,(window.SAPALI_AI_CFG.cacheHours||1)));const xml=raw.raw||'';const items=[...xml.matchAll(/<item>([\s\S]*?)<\/item>/g)].slice(0,5).map(m=>{const t=(m[1].match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/)||[])[1]||(m[1].match(/<title>(.*?)<\/title>/)||[])[1]||'';const l=(m[1].match(/<link>(.*?)<\/link>/)||[])[1]||'';return`• ${t}\n  ${l}`;});return compose({title:`Bản tin nhanh: ${decodeURIComponent(kw)}`,bullets:items.length?items:['Không đọc được RSS (CORS). Hãy thử lại.'],note:'Nguồn: Google News RSS'},true);}async function mathEngine(q){try{const expr=q.match(/[-+/*()0-9.\s]+/g)?.join('')||'';const val=Function('"use strict"; return ('+expr+')')();if(!isFinite(val))throw 0;return compose({title:'Tính toán',bullets:[`${expr} = **${val}**`]},true);}catch(e){return'Không tính được biểu thức.';}}async function internalEngine(q){const KB=JSON.parse(localStorage.getItem('sapali_ai_knowledge')||'[]');const hit=KB.find(x=>(x.q||'').toLowerCase().includes(q.toLowerCase()));if(hit)return compose({title:'Kiến thức nội bộ',bullets:[hit.a],note:'Nguồn: Sapali KB (localStorage)'},true);return'Em chưa tìm thấy nội dung nội bộ phù hợp. Anh có thể cung cấp mã/Dept/WI/ECN cụ thể hơn không?';}async function callEngine(plan,q){const online=!!(window.SAPALI_AI_CFG&&window.SAPALI_AI_CFG.online);if(plan.intent==='internal')return await internalEngine(q);if(!online)return'Chế độ Offline đang bật — chỉ trả lời nội bộ. Bật "Online Free" để dùng bách khoa/kinh tế.';if(plan.intent==='economy'){if(plan.pair||/t[ỷy]\s*gi[aá]/i.test(q))return await econEngine(q);return await wbEngine(q);}if(plan.intent==='news')return await newsEngine(plan.topic||q);if(plan.intent==='math')return await mathEngine(q);return await wikiEngine(plan.topic||q);}window.sendAI=async function(){try{var inp=document.getElementById('aiInput');var q=norm(inp&&inp.value);if(!q)return;bubble('user',q,false);if(inp)inp.value='';var plan=planQuery(q);var ans=await callEngine(plan,q);bubble('ai',ans,true);}catch(e){console.error(e);bubble('ai','Có lỗi khi gọi nguồn miễn phí. Anh thử lại giúp em nhé.',false);}};})();</script></body>
<script id="coreApp">
document.addEventListener('DOMContentLoaded', ()=>{
  const body=document.body;
  // Default LIGHT
  body.classList.add('light');
  const btnDark = document.getElementById('themeDark');
  const btnLight = document.getElementById('themeLight');
  function setTheme(name){
    if(name==='light'){
      body.classList.add('light');
      btnLight && btnLight.classList.add('active');
      btnDark && btnDark.classList.remove('active');
    }else{
      body.classList.remove('light');
      btnDark && btnDark.classList.add('active');
      btnLight && btnLight.classList.remove('active');
    }
  }
  btnDark && (btnDark.onclick = ()=> setTheme('dark'));
  btnLight && (btnLight.onclick = ()=> setTheme('light'));

  function bindTabs(selector){
    const btns = document.querySelectorAll(selector);
    btns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        btns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id = btn.dataset.target;
        if(!id) return;
        document.querySelectorAll('section.view').forEach(s=>s.classList.remove('active'));
        const sec = document.getElementById(id);
        sec && sec.classList.add('active');
      });
    });
  }
  bindTabs('.btab');
  bindTabs('#leftNav .vtab');
});
</script>
<!-- ==== SPEC MODULE (isolated) ==== -->
<!-- ==== /SPEC MODULE ==== -->
<!-- === SPEC MODULE v3 (robust Excel rules: 1–2 dòng header, gộp cha-con) === -->
<script>function fmt3(v){ 
  const n = Number(String(v).replace(/[\s,]/g,'')); 
  if(isFinite(n)) return n.toFixed(3);
  const s = (v===undefined||v===null) ? '' : String(v);
  return (s.trim()==='') ? '—' : s; 
}

function evalIfFormula(v, rowObj){
  if(typeof v === 'string' && v.trim().startsWith('=')){
    const expr = v.replace(/^=/,'').replace(/([A-Z]+)(\d+)/gi,(m, col, r)=>{
      const map = {
        'E': Number((rowObj['inc']??rowObj['kichthuocspinc']??rowObj['kichthuocinc']??rowObj['kich thuoc inc']??0).toString().replace(/,/g,'')),
        'F': Number((rowObj['mm']??rowObj['kichthuocspmm']??rowObj['kichthuocmm']??rowObj['kich thuoc mm']??0).toString().replace(/,/g,'')),
        'I': Number((rowObj['kgm']??rowObj['tytronglythuyetkgm']??0).toString().replace(/,/g,''))
      };
      const val = map[col.toUpperCase()];
      return (isFinite(val)? String(val) : '0');
    });
    try{ const out = Function('return ('+expr+')')(); return isFinite(out)? out : v; }catch(e){ return v; }
  }
  return v;
}

async function resizeAllImages(){
  const cells = document.querySelectorAll('.img-cell');
  const ops = [];
  cells.forEach(cell=>{
    cell.querySelectorAll('img').forEach(img=>{
      ops.push(new Promise(res=>{
        const src = img.getAttribute('src');
        const i = new Image();
        i.onload = ()=>{
          const canvas = document.createElement('canvas');
          canvas.width = 400; canvas.height = 300;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#0b0f14'; ctx.fillRect(0,0,400,300);
          let w = i.width, h = i.height;
          const scale = Math.min(400/w, 300/h);
          w *= scale; h *= scale;
          const x = (400 - w)/2, y = (300 - h)/2;
          ctx.drawImage(i, x, y, w, h);
          img.src = canvas.toDataURL('image/jpeg', 0.82);
          res();
        };
        i.onerror = ()=>res();
        i.src = src;
      }));
    });
  });
  await Promise.all(ops);
}

function attachImageSwipers(){
  document.querySelectorAll('.img-cell').forEach(cell=>{
    const imgs = [...cell.querySelectorAll('img')];
    if(imgs.length===0) return;
    const slides = imgs.map(im=>{
      const wrap = document.createElement('div'); wrap.className='slide';
      im.parentNode.insertBefore(wrap, im); wrap.appendChild(im); return wrap;
    });
    let idx=0; const show=(i)=>{ idx=(i+slides.length)%slides.length; slides.forEach((s,j)=>s.classList.toggle('active', j===idx)); };
    show(0);

    if(slides.length>1){
      const left = document.createElement('div'); left.className='nav left'; left.textContent='‹';
      const right= document.createElement('div'); right.className='nav right'; right.textContent='›';
      cell.appendChild(left); cell.appendChild(right);
      left.onclick = (e)=>{ e.stopPropagation(); show(idx-1); };
      right.onclick= (e)=>{ e.stopPropagation(); show(idx+1); };
      let sx=0,dx=0;
      cell.addEventListener('touchstart',e=>sx=e.touches[0].clientX);
      cell.addEventListener('touchend',e=>{ dx=e.changedTouches[0].clientX-sx; if(Math.abs(dx)>24) show(idx+(dx<0?1:-1)); });
    }

    const zoom = document.createElement('div'); zoom.className='zoom'; zoom.textContent='🔍';
    cell.appendChild(zoom);
    zoom.onclick = (e)=>{
      e.stopPropagation();
      const fs = document.getElementById('imgFullscreen');
      const img = document.getElementById('imgFullscreenImg');
      img.src = imgs[idx].src; fs.style.display='flex';
    };
  });
  const fs = document.getElementById('imgFullscreen');
  const closeBtn = document.getElementById('imgFsClose');
  if(closeBtn){ closeBtn.onclick = ()=>{ fs.style.display='none'; }; }
  if(fs){ fs.addEventListener('click', (e)=>{ if(e.target.id==='imgFullscreen') fs.style.display='none'; }); }
}


function renderOfficial(){
  const tb = document.getElementById('specOfficialTbl');
  if(!tb) return;
  if(!SG_SPEC_FINAL || !SG_SPEC_FINAL.length){
    tb.innerHTML = '<tr><td colspan="14" style="color:var(--muted)">Chưa có dữ liệu</td></tr>';
    return;
  }
  tb.innerHTML = SG_SPEC_FINAL.map(r=>`
    <tr>
      <td>${r.customer||'—'}</td>
      <td>${r.product||'—'}</td>
      <td>${r.tag1||'—'}</td>
      <td>${r.tag2||'—'}</td>
      <td>${fmt3(r.inc)}</td>
      <td>${fmt3(r.mm)}</td>
      <td>${r.material||'—'}</td>
      <td>${fmt3(r.kg_m)}</td>
      <td>${fmt3(r.kg_pcs)}</td>
      <td>${r.process||'—'}</td>
      <td>${(r.images&&r.images.length)?'<div class="img-cell">'+r.images.map(s=>'<img src="'+s+'"/>').join('')+'</div>':'—'}</td>
      <td>${r.total||'—'}</td>
      <td style="white-space:pre-wrap">${r.pallet||'—'}</td>
      <td style="white-space:pre-wrap">${r.note||'—'}</td>
    </tr>
  `).join('');
  attachImageSwipers(); resizeAllImages();
}

function sgKey(x){
  return (x||'').toString().trim().toLowerCase()
   .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
   .replace(/[^a-z0-9]/g,'');
}
function pickField(obj, keys, fb=''){
  for(const k of keys){
    const v = obj[sgKey(k)];
    if(v!=null && String(v).trim()!=='') return v;
  }
  const allKeys = Object.keys(obj||{});
  for(const k of keys){
    const needle = sgKey(k);
    const hit = allKeys.find(kk => kk.includes(needle));
    if(hit){
      const v = obj[hit];
      if(v!=null && String(v).trim()!=='') return v;
    }
  }
  return fb;
}

// ===== helpers =====
function parseImagesObj(o){
  const out=[], seen=new Set();
  const keys=['hinhanh','hinh anh','image','img','anh','linkanh','link anh','url anh','anh san pham','anh sản phẩm','anh minh hoa','ảnh minh hoạ','anh sp','hinhanh1','hinhanh2','hinhanh3','image1','image2','image3','img1','img2','img3','hinh1','hinh2','hinh3'];
  for(const k of keys){
    const v=o[sgKey(k)]; if(!v) continue;
    String(v).split(/[\n;,|]+/).forEach(s=>{ s=s.trim(); if(s && !seen.has(s)){seen.add(s); out.push(s);} });
  }
  return out;
}
function carryDown(objs){
  if(!objs||!objs.length) return objs;
  const last={};
  return objs.map(r=>{
    const o={...r};
    Object.keys(o).forEach(k=>{
      const v = String(o[k]??'').trim();
      if(v===''){ if(last[k]!=null) o[k]=last[k]; } else { last[k]=o[k]; }
    });
    return o;
  });
}
function attachImageSwipers(){
  document.querySelectorAll('.img-cell').forEach(cell=>{
    const imgs = cell.querySelectorAll('img'); if(imgs.length<=1) return;
    let idx=0; const show=i=>{ idx=(i+imgs.length)%imgs.length; imgs.forEach((im,j)=>im.style.display=j===idx?'block':'none'); };
    let sx=0,dx=0;
    cell.addEventListener('touchstart',e=>sx=e.touches[0].clientX);
    cell.addEventListener('touchend',e=>{ dx=e.changedTouches[0].clientX-sx; if(Math.abs(dx)>24) show(idx+(dx<0?1:-1)); });
    cell.addEventListener('click',()=>show(idx+1));
  });
}

const SG_SPEC_STAGE = [];
const SG_SPEC_FINAL = [];

async function needXLSX(){

  if(window.XLSX) return window.XLSX;
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload=()=>res(); s.onerror=()=>rej(new Error('Không tải được XLSX'));
    document.head.appendChild(s);
  });
  return window.XLSX;
}

async function needJSZip(){
  if(window.JSZip) return window.JSZip;
  await new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
    s.onload=()=>res(); s.onerror=()=>rej(new Error('Không tải được JSZip'));
    document.head.appendChild(s);
  });
  return window.JSZip;
}

function buildHeadersFromAOA(aoa){
  const top = aoa.slice(0,5);
  let bestIdx = 0, bestCount = 0;
  top.forEach((row,i)=>{
    const count = row.filter(x=>String(x||'').trim().length>0).length;
    if(count>bestCount){bestCount=count;bestIdx=i;}
  });
  let head1 = aoa[bestIdx] || [];
  let head2 = aoa[bestIdx+1] || [];
  const h1has = head1.some(x=>String(x||'').trim().length);
  const h2has = head2.some(x=>String(x||'').trim().length);
  const useTwo = h1has && h2has && head2.filter(x=>String(x||'').trim()).length >= head1.filter(x=>String(x||'').trim()).length/2;
  const headers = [];
  const maxlen = Math.max(head1.length, head2.length);
  for(let c=0;c<maxlen;c++){
    const p = String(head1[c]||'').trim();
    const ch = String((useTwo? head2[c] : '')||'').trim();
    let name = '';
    if(useTwo){
      if(p && ch) name = p+' '+ch;
      else if(ch) name = ch;
      else if(p) name = p;
    }else{
      name = p;
    }
    headers.push(name);
  }
  return {headers, bestIdx, useTwo};
}

function rowsToObjs(XLSX, ws){
  const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
  if(!aoa.length) return [];
  const meta = buildHeadersFromAOA(aoa);
  const headers = meta.headers;
  const startRow = (meta.bestIdx + (meta.useTwo?2:1));
  const objs = [];
  for(let r=startRow; r<aoa.length; r++){
    const row = aoa[r];
    if(!row || row.every(v=>String(v||'').trim()==='')) continue;
    const o={};
    for(let c=0;c<headers.length;c++){
      const h = headers[c]||'';
      if(!h) continue;
      o[h] = row[c];
    }
    o._row = r+1; // 1-based Excel row index
    objs.push(o);
  }
  return carryDown(objs);
}


function extractCustomerFromSheet(XLSX, ws){
  try{
    const aoa = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    const top = aoa.slice(0,3).flat().map(x=>String(x||''));
    const joined = top.join(' ').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const m =
      joined.match(/khach\s*hang[^a-z0-9]*([a-z0-9_-]{2,})/i) ||
      joined.match(/ma\s*khach\s*hang[^a-z0-9]*([a-z0-9_-]{2,})/i) ||
      joined.match(/\bkh\b[^a-z0-9]*([a-z0-9_-]{2,})/i);
    if(m) return m[1].toUpperCase();
  }catch(e){} 
  return '';
}


function VALIDATE_ROW_SPEC(o){
  // canonical fields
  const name = String(o['tenhang']||o['ten hang']||'').trim();
  const mat  = String(o['vatlieu']||o['vat lieu']||'').trim();
  const inc  = Number(String(o['inc']||'').replace(/[^\d.]/g,''));
  const mm   = Number(String(o['mm']||'').replace(/[^\d.]/g,''));
  const hasSize = isFinite(inc) || isFinite(mm);
  // reject obvious footer / signature / location lines
  const badName = /^(k[\u1ef5]|\u0111i\u1ecba|\u0111\u1ecba|\u0110\u1ecba|gi[aá]m \u0111\u1ed1c|k\u1ef9|ký|ky|ng[uư][o\u01b0]i l[âa]p|ph[êe] duy[ệe]t|ki\u1ec3m tra|h[àa] n[ộo]i|hcm|tp\.? h[ồo] ch[ií] minh)/i.test(name);
  // also reject if entire row is nearly empty
  const almostEmpty = !name && !mat && !hasSize;
  return !badName && !almostEmpty;
}

function toStage(objs, khFallback=''){
  SG_SPEC_STAGE.length = 0;
  for(const row of objs){
    const o = {}; Object.keys(row||{}).forEach(k=> o[sgKey(k)] = row[k]);
    if(VALIDATE_ROW_SPEC(o)) { SG_SPEC_STAGE.push({
      customer : (pickField(o, ['khachhang','khachhangkh','khach hang','customer','kh','ma khach hang','ma kh','mkh','customer code']) || khFallback),
      product  : pickField(o, ['tenhang','ten hang','product','item','ten','sanpham']),
      tag1 : (pickField(o, ['matem','ma tem','matem1','ma tem 1','tem1','tem so 1','label1','ma nhan 1','tem_1']) || (Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[0]? o[Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[0]]:'')),
      tag2 : (pickField(o, ['matem2','ma tem 2','tem2','tem so 2','label2','ma nhan 2','tem_2']) || (Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[1]? o[Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[1]]:'')),
      inc      : evalIfFormula(pickField(o, ['kichthuocspinc','inc','kichthuocinc','kich thuoc inc']), o),
      mm       : evalIfFormula(pickField(o, ['kichthuocspmm','mm','kichthuocmm','kich thuoc mm']), o),
      material : pickField(o, ['vatlieu','vat lieu','material']),
      kg_m     : evalIfFormula(pickField(o, ['tytronglythuyetkgm','kgm','kg/m','(kg/m)','kgtrenm']), o),
      kg_pcs   : evalIfFormula(pickField(o, ['tytronglythuyetkgpcs','kgpcs','kg/pcs','(kg/pcs)','kgtrenpcs']), o),
      process  : pickField(o, ['giacong','gia cong','process']),
      images   : parseImagesObj(o),
      total : pickField(o, ['donggoi tong thanh/plt','donggoitongthanhplt','tongthanhplt','tong thanh/plt','tong thanh plt','tongthanh/plt','tongthanh plt','tongthanhpllt','tong thanh/pllt','tong thanh pllt','pcs/plt','pcs plt','pcsplt','pcs_per_plt','pcs per plt','pcs per pllt','pcsperpallet','pcs per pallet','pcs pallet','pcs/plate']),
      pallet   : pickField(o, ['dong goi quy cach pallet','donggoi quycachpallet','quycachpallet','quy cach pallet','pallet','quy cach']),
      note     : pickField(o, ['ghichu','ghi chu','note','remark'])
    });
        // auto split Tem1/Tem2 if only one column contains 'a/b' or 'a - b'
        (function(){
          const r = SG_SPEC_STAGE[SG_SPEC_STAGE.length-1];
          if(r && (!r.tag2 || String(r.tag2).trim()==='') && r.tag1){
            const s = String(r.tag1).replace(/–/g,'-');
            const m = s.match(/^\s*([^\/\-|,]+)\s*[\/\-,]\s*([^\/\-|,]+)\s*$/);
            if(m){ r.tag1 = m[1].trim(); r.tag2 = m[2].trim(); }
          }
        })();
         }
  }
  renderStage();
}

function renderStage(){
  const tb = document.getElementById('ingestTbl');
  if(!tb){ return; }
  if(!SG_SPEC_STAGE.length){
    tb.innerHTML = '<tr><td colspan="14" style="color:var(--muted)">Chưa có dữ liệu staging</td></tr>';
    const badge=document.getElementById('specCount'); if(badge) badge.textContent='0 dòng staging';
    return;
  }
  tb.innerHTML = SG_SPEC_STAGE.map(r=>`
    <tr>
      <td>${r.customer||'—'}</td>
      <td>${r.product||'—'}</td>
      <td>${r.tag1||'—'}</td>
      <td>${r.tag2||'—'}</td>
      <td>${fmt3(r.inc)}</td>
      <td>${fmt3(r.mm)}</td>
      <td>${r.material||'—'}</td>
      <td>${fmt3(r.kg_m)}</td>
      <td>${fmt3(r.kg_pcs)}</td>
      <td>${r.process||'—'}</td>
      <td>${(r.images&&r.images.length)?'<div class="img-cell">'+r.images.map(s=>'<img src="'+s+'"/>').join('')+'</div>':'—'}</td>
      <td>${r.total||'—'}</td>
      <td style="white-space:pre-wrap">${r.pallet||'—'}</td>
      <td style="white-space:pre-wrap">${r.note||'—'}</td>
    </tr>
  `).join('');
  const badge=document.getElementById('specCount'); if(badge) badge.textContent = SG_SPEC_STAGE.length + ' dòng staging';
  attachImageSwipers(); resizeAllImages();
}

async function handleSpecFile(file){
  if(!file) return;
  const ext = (file.name.split('.').pop()||'').toLowerCase();
  if(ext==='xlsx' || ext==='xls'){
    const XLSX = await needXLSX();
    const ab = await file.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    // extract images by row via JSZip anchors
    let rowImgs = {};
    try{ rowImgs = await extractSheetImages(ab, 0); }catch(e){ rowImgs = {}; }
    const objs = rowsToObjs(XLSX, ws);
    const kh = extractCustomerFromSheet(XLSX, ws);
    extractFooterFromSheet(XLSX, ws);
    renderFooterBox();
    // bind images to row if cell column 'Hình ảnh' is empty
    objs.forEach(o=>{
      const imgs = rowImgs[o._row];
      if(imgs && imgs.length){
        // merge: prefer existing parsed images if any, else use anchors
        const existing = (String(o['Hình ảnh']||o['hinhanh']||o['hinh anh']||'').trim());
        if(!existing){ o['Hình ảnh'] = imgs.join(';'); }
      }
    });
    toStage(objs, kh);
    if(kh){ SG_SPEC_STAGE.forEach(r=>{ if(!r.customer) r.customer=kh; }); renderStage(); }
    return;
  }
  if(ext==='csv'){
    const text = await file.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
    const headers = (lines.shift()||'').split(',').map(h=>h.trim());
    const objs = lines.map(line=>{
      const cells = line.split(',');
      const o={}; headers.forEach((h,i)=> o[h]=cells[i]||''); return o;
    });
    toStage(objs);
    return;
  }
  alert('Định dạng chưa hỗ trợ: '+ext+' — vui lòng dùng Excel/CSV.');
}

function specQA(){
  const tb=document.getElementById('ingestTbl');
  if(!tb || !SG_SPEC_STAGE.length){ alert('Chưa có dữ liệu staging'); return; }
  let bad=0;
  [...tb.querySelectorAll('tr')].forEach(tr=>{
    const tds=tr.querySelectorAll('td');
    const req=[0,1,2,5];
    let miss=false;
    req.forEach(i=>{ if(!tds[i] || tds[i].textContent.trim()==='—') miss=true; });
    const incOK=tds[3] && tds[3].textContent.trim()!=='—';
    const mmOK =tds[4] && tds[4].textContent.trim()!=='—';
    if(!(incOK||mmOK)) miss=true;
    if(miss){ bad++; tr.style.background='rgba(255,165,0,.08)'; }
  });
  alert(`QA: ${bad}/${SG_SPEC_STAGE.length} dòng thiếu thông tin.`);
}

function specApprove(){ SG_SPEC_FINAL.length=0; SG_SPEC_FINAL.push(...SG_SPEC_STAGE); SG_SPEC_STAGE.length=0; renderStage(); renderOfficial(); const card=document.getElementById('specIngestCard'); if(card) card.style.display='none'; alert('Đã Approval staging.'); }
function specClear(){ SG_SPEC_STAGE.length=0; renderStage(); }

document.addEventListener('DOMContentLoaded', ()=>{
  const file = document.getElementById('fileSpec');
  const pick = document.getElementById('btnPickSpec');
  const btnA = document.getElementById('btnSpecApprove');
  const btnC = document.getElementById('btnSpecClear');
  const btnOpen = document.getElementById('btnOpenSpecUpload');
  if(btnOpen){ btnOpen.onclick = ()=>{ const card=document.getElementById('specIngestCard'); if(card){ card.style.display=''; card.scrollIntoView({behavior:'smooth', block:'start'}); } }; }
  renderOfficial();
  if(pick) pick.onclick = ()=> file && file.click();
  if(file) file.onchange = e=> handleMultiple(Array.from(e.target.files||[]));
  if(btnA) btnA.onclick = specApprove;
  if(btnC) btnC.onclick = specClear;
  window.sg_runDataQA = specQA;
});


async function handleMultiple(files){
  if(!files || !files.length) return;
  if(files.length===1){ await handleSpecFile(files[0]); return; }
  SG_SPEC_STAGE.length = 0;
  for(const f of files){
    const ext=(f.name.split('.').pop()||'').toLowerCase();
    if(ext==='xlsx'||ext==='xls'){
      const XLSX = await needXLSX();
      const ab = await f.arrayBuffer();
      const wb = XLSX.read(ab,{type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const objs = rowsToObjs(XLSX, ws);
      const kh = extractCustomerFromSheet(XLSX, ws);
    extractFooterFromSheet(XLSX, ws);
    renderFooterBox();
      for(const row of objs){
        const o={}; Object.keys(row||{}).forEach(k=> o[sgKey(k)]=row[k]);
        if(VALIDATE_ROW_SPEC(o)) { SG_SPEC_STAGE.push({
          customer : (pickField(o, ['khachhang','khachhangkh','khach hang','customer','kh','ma khach hang','ma kh','mkh','customer code']) || kh),
          product  : pickField(o, ['tenhang','ten hang','product','item','ten','sanpham']),
          tag1 : (pickField(o, ['matem','ma tem','matem1','ma tem 1','tem1','tem so 1','label1','ma nhan 1','tem_1']) || (Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[0]? o[Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[0]]:'')),
          tag2 : (pickField(o, ['matem2','ma tem 2','tem2','tem so 2','label2','ma nhan 2','tem_2']) || (Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[1]? o[Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[1]]:'')),
          inc      : evalIfFormula(pickField(o, ['kichthuocspinc','inc','kichthuocinc','kich thuoc inc']), o),
          mm       : evalIfFormula(pickField(o, ['kichthuocspmm','mm','kichthuocmm','kich thuoc mm']), o),
          material : pickField(o, ['vatlieu','vat lieu','material']),
          kg_m     : evalIfFormula(pickField(o, ['tytronglythuyetkgm','kgm','kg/m','(kg/m)','kgtrenm']), o),
          kg_pcs   : evalIfFormula(pickField(o, ['tytronglythuyetkgpcs','kgpcs','kg/pcs','(kg/pcs)','kgtrenpcs']), o),
          process  : pickField(o, ['giacong','gia cong','process']),
          images   : parseImagesObj(o),
          total : pickField(o, ['donggoi tong thanh/plt','donggoitongthanhplt','tongthanhplt','tong thanh/plt','tong thanh plt','tongthanh/plt','tongthanh plt','tongthanhpllt','tong thanh/pllt','tong thanh pllt','pcs/plt','pcs plt','pcsplt','pcs_per_plt','pcs per plt','pcs per pllt','pcsperpallet','pcs per pallet','pcs pallet','pcs/plate']),
          pallet   : pickField(o, ['dong goi quy cach pallet','donggoi quycachpallet','quycachpallet','quy cach pallet','pallet','quy cach']),
          note     : pickField(o, ['ghichu','ghi chu','note','remark'])
        });
        // auto split Tem1/Tem2 if only one column contains 'a/b' or 'a - b'
        (function(){
          const r = SG_SPEC_STAGE[SG_SPEC_STAGE.length-1];
          if(r && (!r.tag2 || String(r.tag2).trim()==='') && r.tag1){
            const s = String(r.tag1).replace(/–/g,'-');
            const m = s.match(/^\s*([^\/\-|,]+)\s*[\/\-,]\s*([^\/\-|,]+)\s*$/);
            if(m){ r.tag1 = m[1].trim(); r.tag2 = m[2].trim(); }
          }
        })();
         }
      }
    } else if(ext==='csv'){
      const text = await f.text();
      const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      const headers = (lines.shift()||'').split(',').map(h=>h.trim());
      let kh='';
      const objs = lines.map(line=>{
        const cells = line.split(',');
        const o={}; headers.forEach((h,i)=> o[h]=cells[i]||''); return o;
      });
      for(const row of objs){
        const o={}; Object.keys(row||{}).forEach(k=> o[sgKey(k)]=row[k]);
        if(VALIDATE_ROW_SPEC(o)) { SG_SPEC_STAGE.push({
          customer : (pickField(o, ['khachhang','khachhangkh','khach hang','customer','kh','ma khach hang','ma kh','mkh','customer code']) || kh),
          product  : pickField(o, ['tenhang','ten hang','product','item','ten','sanpham']),
          tag1 : (pickField(o, ['matem','ma tem','matem1','ma tem 1','tem1','tem so 1','label1','ma nhan 1','tem_1']) || (Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[0]? o[Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[0]]:'')),
          tag2 : (pickField(o, ['matem2','ma tem 2','tem2','tem so 2','label2','ma nhan 2','tem_2']) || (Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[1]? o[Object.keys(o).filter(k=>k.includes('matem')||k.includes('ma tem'))[1]]:'')),
          inc      : evalIfFormula(pickField(o, ['kichthuocspinc','inc','kichthuocinc','kich thuoc inc']), o),
          mm       : evalIfFormula(pickField(o, ['kichthuocspmm','mm','kichthuocmm','kich thuoc mm']), o),
          material : pickField(o, ['vatlieu','vat lieu','material']),
          kg_m     : evalIfFormula(pickField(o, ['tytronglythuyetkgm','kgm','kg/m','(kg/m)','kgtrenm']), o),
          kg_pcs   : evalIfFormula(pickField(o, ['tytronglythuyetkgpcs','kgpcs','kg/pcs','(kg/pcs)','kgtrenpcs']), o),
          process  : pickField(o, ['giacong','gia cong','process']),
          images   : parseImagesObj(o),
          total : pickField(o, ['donggoi tong thanh/plt','donggoitongthanhplt','tongthanhplt','tong thanh/plt','tong thanh plt','tongthanh/plt','tongthanh plt','tongthanhpllt','tong thanh/pllt','tong thanh pllt','pcs/plt','pcs plt','pcsplt','pcs_per_plt','pcs per plt','pcs per pllt','pcsperpallet','pcs per pallet','pcs pallet','pcs/plate']),
          pallet   : pickField(o, ['dong goi quy cach pallet','donggoi quycachpallet','quycachpallet','quy cach pallet','pallet','quy cach']),
          note     : pickField(o, ['ghichu','ghi chu','note','remark'])
        }); }
      }
    }
  }
  renderStage();
}


async function extractSheetImages(ab, sheetIndex=0){
  const JSZip = await needJSZip();
  const zip = await JSZip.loadAsync(ab);
  // Map rel id -> target for drawing1
  function textFile(path){ const f = zip.file(path); return f? f.async('text'): Promise.resolve(''); }
  function exists(path){ return !!zip.file(path); }
  // Find the worksheet drawing rel from sheetN.xml.rels
  const sheetPath = `xl/worksheets/sheet${sheetIndex+1}.xml`;
  const sheetRelsPath = `xl/worksheets/_rels/sheet${sheetIndex+1}.xml.rels`;
  let drawingPath = 'xl/drawings/drawing1.xml';
  const rels = exists(sheetRelsPath) ? await textFile(sheetRelsPath) : '';
  const mDraw = rels.match(/Target="(..\/drawings\/drawing\d+\.xml)"/);
  if(mDraw){ drawingPath = 'xl/' + mDraw[1].replace('../',''); }
  const drawingRelsPath = drawingPath.replace('xl/drawings/','xl/drawings/_rels/') + '.rels';
  const drawingXml = exists(drawingPath) ? await textFile(drawingPath) : '';
  const dRels = exists(drawingRelsPath) ? await textFile(drawingRelsPath) : '';
  const relMap = {};
  dRels.replace(/Id="(rId\d+)"[^>]*Target="(..\/media\/image\d+\.[a-zA-Z]+)"/g, (m,id,target)=>{ relMap[id] = 'xl/' + target.replace('../',''); return m; });
  // Parse anchors -> row indices
  const imageAnchors = [];
  drawingXml.replace(/twoCellAnchor[\s\S]*?<from>[\s\S]*?<row>(\d+)<\/row>[\s\S]*?<col>(\d+)<\/col>[\s\S]*?<\/from>[\s\S]*?blip[^>]*r:embed="(rId\d+)"[\s\S]*?<\/twoCellAnchor>/g,
    (m,row,col,rid)=>{ imageAnchors.push({row: parseInt(row,10)+1, col: parseInt(col,10)+1, rid}); return m; });
  // Build map: row -> array of object URLs
  const rowMap = {};
  for(const a of imageAnchors){
    const mediaPath = relMap[a.rid];
    if(!mediaPath) continue;
    const file = zip.file(mediaPath);
    if(!file) continue;
    const blob = await file.async('blob');
    const url = URL.createObjectURL(blob);
    if(!rowMap[a.row]) rowMap[a.row]=[];
    rowMap[a.row].push(url);
  }
  return rowMap;
}

</script>
<!-- === /SPEC MODULE v3 === -->

<script>
/* ================= Sapali AI + Sản phẩm DEMO (15 mẫu) ================= */

// --- 15 sản phẩm demo ---
const DEMO_PRODUCTS = [
  {code:'XLE-100', name:'Ốp trang trí XLE', group:'PVC', status:'Đang bán',
   desc:'PVC Foam; Inc 96.000; mm 2438.400', 
   images:['https://picsum.photos/seed/xle100a/640/480','https://picsum.photos/seed/xle100b/640/480'],
   spec:{'Tem 1':'100','Tem 2':'117','INC':'96.000','MM':'2438.400','Vật liệu':'PVC Foam','(kg/m)':'0.343','(kg/pcs)':'0.837','Gia công':'Cắt CNC','Tổng/PLT':'420 pcs/plt','Quy cách pallet':'Đóng theo bó...'},
   bom:[['1','GLUE-A','1.0','Keo dán'],['1','WRAP-B','1.0','Màng bọc']]},
  {code:'ALU-45R', name:'Thanh nhôm 45R', group:'AL', status:'Đang bán',
   desc:'Al6063-T5; Inc 45.000; mm 6000.000', 
   images:['https://picsum.photos/seed/alu45r/640/480'],
   spec:{'Tem 1':'45','Tem 2':'R','INC':'45.000','MM':'6000.000','Vật liệu':'AL6063-T5','Gia công':'Ép đùn + Anode'},
   bom:[['1','ANODE-CL','1','Xử lý bề mặt']]},
  {code:'PVC-CLIP-12', name:'Kẹp PVC 12', group:'PVC', status:'Mới',
   desc:'PVC cứng; Inc 12.000; mm 200.000',
   images:['https://picsum.photos/seed/pvcclip12/640/480'],
   spec:{'Tem 1':'12','INC':'12.000','MM':'200.000','Vật liệu':'PVC'},
   bom:[['1','PVC-RESIN','0.1','Hạt nhựa']]},
  {code:'BRKT-SS-01', name:'Giá đỡ Inox 01', group:'INOX', status:'Đang bán',
   desc:'SUS304; mm 80 x 40 x 2',
   images:['https://picsum.photos/seed/brktss01/640/480'],
   spec:{'Tem 1':'01','Vật liệu':'SUS304','(kg/pcs)':'0.220','Gia công':'Dập + Hàn TIG'},
   bom:[['1','WELD-ROD-308','0.01','Que hàn']]},
  {code:'PCB-CTRL-A1', name:'PCB điều khiển A1', group:'PCB', status:'Đang phát triển',
   desc:'FR4; 4L; 100x60mm', images:['https://picsum.photos/seed/pcba1/640/480'],
   spec:{'Tem 1':'A1','Vật liệu':'FR4','Gia công':'SMT + DIP'},
   bom:[['1','MCU-STM32','1','Điều khiển'],['1','RES-0603','10','Điện trở']]},
  {code:'RUB-FOAM-10', name:'Gioăng bọt 10', group:'RUB', status:'Đang bán',
   desc:'EPDM Foam; Inc 10.000', images:['https://picsum.photos/seed/rubfoam10/640/480'],
   spec:{'Tem 1':'10','Vật liệu':'EPDM Foam','(kg/m)':'0.050','Gia công':'Cán + Dán keo'},
   bom:[['1','TAPE-3M','1','Băng keo']]},
  {code:'SAP-PLUG-22', name:'Nút bịt đầu 22mm', group:'PP', status:'Đang bán',
   desc:'PP; Inc 22.000; mm 30.000', images:['https://picsum.photos/seed/plug22/640/480'],
   spec:{'Tem 1':'22','INC':'22.000','MM':'30.000','Vật liệu':'PP','(kg/pcs)':'0.110','Gia công':'Ép phun'},
   bom:[['1','COLOR-BLK','0.01','Hạt màu']]},
  {code:'HOSE-CLR-6', name:'Ống trong 6mm', group:'PU', status:'Đang bán',
   desc:'PU; Ø6x4mm; cuộn 100m', images:['https://picsum.photos/seed/hose6/640/480'],
   spec:{'Tem 1':'6','Vật liệu':'PU','Gia công':'Đùn ống'}},
  {code:'LBL-SET-01', name:'Bộ tem dán 01', group:'LABEL', status:'Đang bán',
   desc:'Giấy PVC; 100/117', images:['https://picsum.photos/seed/lblset01/640/480'],
   spec:{'Tem 1':'100','Tem 2':'117','Gia công':'In + Bế'}},
  {code:'CAP-ABS-20', name:'Nắp ABS 20', group:'ABS', status:'Đang bán',
   desc:'ABS; Ø20; màu đen', images:['https://picsum.photos/seed/capabs20/640/480'],
   spec:{'Tem 1':'20','(kg/pcs)':'0.030','Gia công':'Ép phun'}},
  {code:'SEAL-NBR-30', name:'Phớt NBR 30', group:'NBR', status:'Đang bán',
   desc:'NBR; Ø30x5', images:['https://picsum.photos/seed/sealnbr30/640/480'],
   spec:{'Tem 1':'30','Gia công':'Ép khuôn'}},
  {code:'WIR-HAR-5P', name:'Dây harness 5P', group:'WIRE', status:'Đang bán',
   desc:'AWG24; dài 500mm', images:['https://picsum.photos/seed/wirhar5p/640/480'],
   spec:{'Tem 1':'5P','Gia công':'Ép cos + Bó'}},
  {code:'FOIL-AL-0.2', name:'Giấy nhôm 0.2', group:'AL', status:'Đang bán',
   desc:'Al foil 0.2mm', images:['https://picsum.photos/seed/foilal02/640/480'],
   spec:{'Tem 1':'0.2','Gia công':'Cắt cuộn'}},
  {code:'BRKT-AL-02', name:'Giá đỡ nhôm 02', group:'AL', status:'Đang bán',
   desc:'AL6061; 100x50x3', images:['https://picsum.photos/seed/brktal02/640/480'],
   spec:{'Tem 1':'02','(kg/pcs)':'0.180','Gia công':'Phay CNC'}},
  {code:'KIT-TEST-A', name:'Bộ kit kiểm A', group:'KIT', status:'Đang bán',
   desc:'Bao gồm 5 món', images:['https://picsum.photos/seed/kittestA/640/480'],
   spec:{'Tem 1':'A','Gia công':'Lắp ráp'}}
];

// ==== PRODUCTS MODULE ====
function renderProductRows(list){
  const tb = document.getElementById('prodList');
  if(!tb) return;
  if(!list || !list.length){
    tb.innerHTML = '<tr><td colspan="4" style="color:var(--muted)">Không có sản phẩm</td></tr>';
    return;
  }
  tb.innerHTML = list.map(p=>`
    <tr class="row-prod" data-code="${p.code}">
      <td>${p.code}</td>
      <td>${p.name}</td>
      <td>${p.group||'—'}</td>
      <td><span class="pill">${p.status||'—'}</span></td>
    </tr>
  `).join('');
  document.querySelectorAll('.row-prod').forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const code = tr.dataset.code;
      const pr = DEMO_PRODUCTS.find(x=>x.code===code);
      if(pr) showProductDetail(pr);
    });
  });
}

function showProductDetail(p){
  const card = document.getElementById('prodDetailCard'); 
  const code = document.getElementById('prodCode');
  const desc = document.getElementById('prodDesc');
  const imgBox = document.getElementById('imgBox');
  const specTbl = document.getElementById('specTbl');
  const bomTbl = document.getElementById('bomTbl');
  if(!card) return;
  card.style.display = '';
  code.textContent = p.code + ' — ' + (p.name||'');
  desc.textContent = p.desc||'—';
  // images
  imgBox.innerHTML = (p.images||[]).map(u=>`<img src="${u}" style="width:160px;height:110px;object-fit:cover;border-radius:10px;border:var(--border)">`).join('');
  // spec
  const spec = p.spec||{};
  specTbl.innerHTML = Object.keys(spec).map(k=>`<tr><th style="width:180px">${k}</th><td>${spec[k]||'—'}</td></tr>`).join('') || '<tr><td>—</td></tr>';
  // bom
  const bom = p.bom||[];
  bomTbl.innerHTML = bom.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]||''}</td></tr>`).join('') || '<tr><td>—</td></tr>';
}

// Search box (desktop + mobile)
function hookSearchBoxes(){
  const qd = document.getElementById('q_d');
  const qm = document.getElementById('q_m');
  const btn_d = document.getElementById('btnSearch_d');
  const btn_m = document.getElementById('btnSearch_m');
  const doSearch = ()=>{
    const q = (qd && qd.value ? qd.value : (qm? qm.value : '')).toLowerCase();
    const hits = DEMO_PRODUCTS.filter(p => 
      p.code.toLowerCase().includes(q) ||
      (p.name||'').toLowerCase().includes(q) ||
      (p.desc||'').toLowerCase().includes(q) ||
      (p.group||'').toLowerCase().includes(q)
    );
    renderProductRows(hits.length ? hits : DEMO_PRODUCTS);
  };
  btn_d && (btn_d.onclick = doSearch);
  btn_m && (btn_m.onclick = doSearch);
}

// ==== AI PANEL ====
function toggleAI(show){
  const p = document.getElementById('aiPanel');
  if(!p) return;
  p.style.display = show ? 'flex' : 'none';
  if(show){ const i=document.getElementById('aiInput'); i && i.focus(); }
}

function localAISearch(q){
  const qq = (q||'').toLowerCase();
  const hits = DEMO_PRODUCTS.filter(p =>
    p.code.toLowerCase().includes(qq) ||
    (p.name||'').toLowerCase().includes(qq) ||
    (p.desc||'').toLowerCase().includes(qq) ||
    (p.group||'').toLowerCase().includes(qq)
  ).slice(0,5);

  const items = hits.map(p => ({
    code: p.code, name: p.name, desc: p.desc, thumb: (p.images||[])[0]||null,
    images: p.images||[], spec: Object.entries(p.spec||{}).map(([k,v])=> `${k}: ${v}`).join(' ; ')
  }));
  const answer = hits.length ? `Tìm thấy ${hits.length} sản phẩm phù hợp.` : 'Chưa thấy dữ liệu phù hợp.';
  return {answer, items, citations: []};
}

async function sendAI(){
  const box = document.getElementById('aiMsgs');
  const input = document.getElementById('aiInput');
  const q = (input.value||'').trim(); if(!q) return;
  const u = document.createElement('div'); u.className='bubble user'; u.textContent=q; box.appendChild(u);
  const a = document.createElement('div'); a.className='bubble ai'; a.textContent='Đang suy nghĩ…'; box.appendChild(a);
  box.scrollTop = box.scrollHeight; input.value='';

  let data=null;
  try{
    const r = await fetch('/api/ai/query', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({userId:'demo', message:q, topK:5})
    });
    if(r.ok){ data = await r.json(); }
  }catch(e){}
  if(!data){ data = localAISearch(q); }

  a.innerHTML = data.answer || '—';
  if(Array.isArray(data.items)){
    data.items.forEach(it => {
      const card = document.createElement('div');
      card.className = 'result-card';
      card.innerHTML = `
        <div class="result-row">
          <div class="result-thumb">${it.thumb? `<img src="${it.thumb}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">`:''}</div>
          <div>
            <div style="font-weight:800">${it.code||''} — ${it.name||''}</div>
            <div style="color:var(--muted);margin:4px 0">${it.desc||''}</div>
            ${it.spec? `<div><b>Spec:</b> ${it.spec}</div>`:''}
            ${it.images && it.images.length ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">
              ${it.images.slice(0,6).map(u=>`<img src="${u}" style="width:72px;height:72px;border-radius:8px;object-fit:cover">`).join('')}
            </div>`:''}
          </div>
        </div>`;
      box.appendChild(card);
    });
  }
  box.scrollTop = box.scrollHeight;
}

// Bind AI open on brand click (in case HTML brand already has onclick, this is safe)
document.addEventListener('DOMContentLoaded', ()=>{
  renderProductRows(DEMO_PRODUCTS);
  hookSearchBoxes();
  const brand = document.getElementById('brandAI');
  if(brand && !brand._sapaliBind){
    brand.addEventListener('click', ()=> toggleAI(true));
    brand._sapaliBind = true;
  }
  const aiInput = document.getElementById('aiInput');
  if(aiInput && !aiInput._sapaliKey){
    aiInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ sendAI(); } });
    aiInput._sapaliKey = true;
  }
});

document.addEventListener('DOMContentLoaded', function(){
  try{
    var btns = document.querySelectorAll('#aiPanel button');
    btns.forEach(function(b){
      if((b.textContent||'').trim()==='Gửi'){
        b.addEventListener('click', function(ev){ if(window.sendAI) window.sendAI(); }, {capture:true});
      }
    });
  }catch(e){}
});
</script>

</html>